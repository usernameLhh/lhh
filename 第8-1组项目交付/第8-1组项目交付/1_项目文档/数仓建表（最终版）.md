# 一、ODS层(总计27张表)

## 1.1 全量表（总计12张表）

### 1.1.1 ods_base_category_full 	品类表（全量表）

```mysql
DROP TABLE IF EXISTS ods_base_category_info_full;
CREATE EXTERNAL TABLE ods_base_category_info_full
(
    `id`            STRING COMMENT '编号',
    `category_name` STRING COMMENT '分类名称',
    `create_time`   STRING COMMENT '创建时间',
    `update_time`   STRING COMMENT '更新时间',
    `deleted`       STRING COMMENT '是否删除'
) COMMENT '分类表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_base_category_info_full/';
```

### 1.1.2 ods_base_province_full	省份表

```mysql
DROP TABLE IF EXISTS ods_base_province_full;
CREATE EXTERNAL TABLE ods_base_province_full
(
    `id`         STRING COMMENT '编号',
    `name`       STRING COMMENT '省份名称',
    `region_id`  STRING COMMENT '大区ID',
    `area_code`  STRING COMMENT '行政区位码',
    `iso_code`   STRING COMMENT '国际编码',
    `iso_3166_2` STRING COMMENT 'ISO3166 编码'
) COMMENT '省份表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_base_province_full/';

```

### 1.1.3 ods_base_source_full	来源表

```mysql
DROP TABLE IF EXISTS ods_base_source_full;
CREATE EXTERNAL TABLE  ods_base_source_full
(
    `id`          STRING COMMENT '编号',
    `source_site` STRING COMMENT '引流来源名称',
    `source_url`  STRING COMMENT '引流来源名称'
) COMMENT '来源表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_base_source_full/';
```

### 1.1.4 ods_cart_info_inc	购物车表

```mysql
DROP TABLE IF EXISTS ods_cart_info_full;
CREATE EXTERNAL TABLE ods_cart_info_full
(
    `id`          STRING COMMENT '编号',
    `user_id`     STRING COMMENT '用户id',
    `course_id`   STRING COMMENT '课程id',
    `course_name` STRING COMMENT '课程名称',
    `cart_price`  DECIMAL(16, 2) COMMENT '放入购物车时价格',
    `img_url`     BIGINT COMMENT '商品图片地址',
    `session_id` STRING COMMENT '会话id',
    `create_time` STRING COMMENT '创建时间',
    `update_time` STRING COMMENT '修改时间',
    `deleted`     STRING COMMENT '是否删除',
    `sold`      STRING COMMENT '是否已售'
) COMMENT '购物车全量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_cart_info_full/';
```

### 1.1.5 ods_video_info_full	视频表

```mysql
DROP TABLE IF EXISTS ods_video_info_full;
CREATE EXTERNAL TABLE ods_video_info_full
(
    `id`            STRING COMMENT '编号',
    `video_name`  STRING COMMENT '视频名称',
    `during_sec`    BIGINT COMMENT '时长',
    `video_status`     STRING COMMENT '视频状态',
    `video_size` STRING COMMENT '视频大小',
    `video_url`   STRING COMMENT '视频存储路径',
    `video_source_id`   STRING COMMENT '云端资源编号',
    `version_id`  STRING COMMENT '版本号id',
    `chapter_id`       STRING COMMENT '章节id',
    `course_id`       STRING COMMENT '课程id',
     `publisher_id`  STRING COMMENT '发布者id',
    `create_time`   STRING COMMENT '创建时间',
    `update_time`   STRING COMMENT '更新时间',
    `deleted`       STRING COMMENT '是否删除'
) COMMENT '视频表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_video_info_full/';
```

### 1.1.6 ods_base_subject_info_full	科目表

```mysql
DROP TABLE IF EXISTS ods_base_subject_info_full;
CREATE EXTERNAL TABLE ods_base_subject_info_full
(
    `id`           STRING COMMENT '编号',
    `subject_name` STRING COMMENT '科目名称',
    `category_id`  STRING COMMENT '分类编号',
    `create_time`  STRING COMMENT '创建时间',
    `update_time`  STRING COMMENT '更新时间',
    `deleted`      STRING COMMENT '是否删除'
) COMMENT '科目表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_base_subject_info_full/';
```

### 1.1.7 ods_chapter_info_full	章节表

```mysql
DROP TABLE IF EXISTS ods_chapter_info_full;
CREATE EXTERNAL TABLE ods_chapter_info_full
(
    `id`           STRING COMMENT '编号',
    `chapter_name` STRING COMMENT '章节名称',
    `course_id`    STRING COMMENT '课程id',
    `video_id`     STRING COMMENT '视频id',
    `publisher_id` STRING COMMENT '发布者id',
    `is_free`      STRING COMMENT '是否免费',
    `create_time`  STRING COMMENT '创建时间',
    `deleted`      STRING COMMENT '是否删除',
    `update_time`  STRING COMMENT '更新时间' 
) COMMENT '章节表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_chapter_info_full/';

```

### 1.1.8 ods_course_info_full	课程信息

```mysql
DROP TABLE IF EXISTS ods_course_info_full;
CREATE EXTERNAL TABLE ods_course_info_full
(
    `id`               STRING COMMENT '课程编号',
    `course_name`      STRING COMMENT '课程名称',
    `course_slogan`    STRING COMMENT '课程标语',
    `course_cover_url`    STRING COMMENT '课程封面',
    `subject_id`       STRING COMMENT '学科id',
    `teacher`          STRING COMMENT '讲师名称',
    `publisher_id`     STRING COMMENT '发布者id',
    `chapter_num`      BIGINT COMMENT '章节数',
    `origin_price`     DECIMAL(16, 2) COMMENT '价格',
    `reduce_amount`    DECIMAL(16, 2) COMMENT '优惠金额',
    `actual_price`     DECIMAL(16, 2) COMMENT '实际价格',
    `course_introduce` STRING COMMENT '课程介绍',
    `create_time`      STRING COMMENT '创建时间',
     `deleted`          STRING COMMENT '是否删除'
    `update_time`      STRING COMMENT '修改时间'
) COMMENT '课程信息表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_course_info_full/';
```

### 1.1.9 ods_test_paper_question_inc	试卷问题表

```mysql
DROP TABLE IF EXISTS ods_test_paper_question_full;
CREATE EXTERNAL TABLE ods_test_paper_question_full
(
    `id`            STRING COMMENT '编号',
    `paper_id`  STRING COMMENT '试卷id',
    `question_id`     STRING COMMENT '问题id',
    `score` STRING COMMENT '得分',
    `create_time`   STRING COMMENT '创建时间',
    `deleted`       STRING COMMENT '是否删除',
    `publisher_id`   STRING COMMENT '发布者id'
) COMMENT '试卷问题表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_test_paper_question_full/';
```

### 1.1.10 ods_test_paper_full	试卷全量表

```mysql
DROP TABLE IF EXISTS ods_test_paper_full;
CREATE EXTERNAL TABLE ods_test_paper_full
(
    `id`           STRING COMMENT '编号',
    `paper_title`  STRING COMMENT '试卷名称',
    `course_id`    STRING COMMENT '课程id',
    `create_time`  STRING COMMENT '创建时间',
    `update_time`  STRING COMMENT '更新时间',
    `publisher_id` STRING COMMENT '发布者id',
    `deleted`      STRING COMMENT '是否删除'
) COMMENT '试卷表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_test_paper_full/';
```

### 1.1.11 ods_knowledge_point_full	知识点信息表

```mysql
DROP TABLE IF EXISTS ods_knowledge_point_full;
CREATE EXTERNAL TABLE ods_knowledge_point_full
(
    `id`           STRING COMMENT '编号',
    `point_txt`    STRING COMMENT '知识点内容',
    `point_level`  BIGINT COMMENT '知识点级别',
    `course_id`   STRING COMMENT '课程id',
    `chapter_id`   STRING COMMENT '章节id',
    `create_time`  STRING COMMENT '创建时间',
    `update_time`  STRING COMMENT '更新时间',
    `publisher_id` STRING COMMENT '发布者id',
    `deleted`      STRING COMMENT '是否删除'
) COMMENT '知识点表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_knowledge_point_full/';
```

### 1.1.12 ods_test_question_info_full	问题信息表

```mysql
DROP TABLE IF EXISTS ods_test_question_info_full;
CREATE EXTERNAL TABLE ods_test_question_info_full
(
    `id`            STRING COMMENT '编号',
    `question_txt`  STRING COMMENT '题目内容',
    `chapter_id`    STRING COMMENT '章节id',
    `course_id`     STRING COMMENT '课程id',
    `question_type` STRING COMMENT '题目类型',
    `create_time`   STRING COMMENT '创建时间',
    `update_time`   STRING COMMENT '更新时间',
    `publisher_id`  STRING COMMENT '发布者id',
    `deleted`       STRING COMMENT '是否删除'
) COMMENT '问题信息表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/edu/ods/ods_test_question_info_full/';

```

## 1.2 增量表（总计15张表）

### 1.2.1 ods_test_point_question_inc	知识点问题表（增量表）

```mysql
DROP TABLE IF EXISTS ods_test_point_question_inc;
CREATE EXTERNAL TABLE ods_test_point_question_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,point_id :STRING,question_id :STRING, create_time :STRING,publisher_id :STRING, deleted
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '知识点问题表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_test_point_question_inc/';
```

### 1.2.2 ods_user_info_inc	用户表

```mysql
DROP TABLE IF EXISTS ods_user_info_inc;
CREATE EXTERNAL TABLE  ods_user_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,login_name :STRING,nick_name :STRING,passwd :STRING,real_name :STRING,phone_num :STRING,email
                  :STRING,head_img :STRING,user_level :STRING,birthday :STRING,gender :STRING,create_time :STRING,operate_time
                  :STRING,status :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '用户表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_user_info_inc/';DROP TABLE IF EXISTS ods_user_chapter_process_inc;
CREATE EXTERNAL TABLE ods_user_chapter_process_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,course_id :STRING,chapter_id :STRING,user_id :STRING,position_sec :STRING, create_time
                  :STRING,update_time :STRING, deleted :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '用户章节进度表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_user_chapter_process_inc/';
```

### 1.2.3 ods_vip_change_detail_inc	VIP变化表

```mysql
DROP TABLE IF EXISTS ods_vip_change_detail_inc;
CREATE EXTERNAL TABLE ods_vip_change_detail_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,user_id :STRING,from_vip :STRING,to_vip :STRING, create_time :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT 'VIP变化表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_vip_change_detail_inc/';
    
```

### 1.2.4 ods_log_inc	日志表

```mysql
DROP TABLE IF EXISTS ods_log_inc;
CREATE EXTERNAL TABLE ods_log_inc
(
    `common`   STRUCT<ar :STRING,ba :STRING,ch :STRING,is_new :STRING,md :STRING,mid :STRING,os :STRING,sc :STRING,sid
                      :STRING,uid :STRING,vc
                      :STRING> COMMENT '公共信息',
    `appVideo` STRUCT<play_sec : STRING,position_sec :STRING,video_id :
                      STRING> COMMENT '视频信息',
    `page`     STRUCT<during_time :BIGINT,item :STRING,item_type :STRING,last_page_id :STRING,page_id
                      :STRING> COMMENT '页面信息',
    `actions`  ARRAY<STRUCT<action_id:STRING,item:STRING,item_type:STRING,ts:BIGINT>> COMMENT '动作信息',
    `displays` ARRAY<STRUCT<display_type :STRING,item :STRING,item_type :STRING,`order` :BIGINT,pos_id
                            :BIGINT>> COMMENT '曝光信息',
    `start`    STRUCT<entry :STRING,first_open :STRING,loading_time :BIGINT,open_ad_id :BIGINT,open_ad_ms :BIGINT,open_ad_skip_ms
                      :BIGINT> COMMENT '启动信息',
    `err`      STRUCT<error_code:BIGINT,msg:STRING> COMMENT '错误信息',
    `ts`       BIGINT COMMENT '时间戳'
) COMMENT '日志表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_log_inc/';
```

### 1.2.5 ods_cart_info_inc	加购表

```mysql
DROP TABLE IF EXISTS ods_cart_info_inc;
CREATE EXTERNAL TABLE ods_cart_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,user_id :STRING, course_id :STRING,course_name :STRING, cart_price :STRING,img_url
                  :STRING, session_id :STRING,create_time :STRING,update_time :STRING,deleted :STRING,sold
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '加购增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_cart_info_inc/';
```

### 1.2.6 ods_comment_info_inc	章节评价增量表

```mysql
DROP TABLE IF EXISTS ods_comment_info_inc;
CREATE EXTERNAL TABLE ods_comment_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,user_id :STRING, chapter_id :STRING,course_id :STRING, comment_txt :STRING,create_time
                  :STRING, deleted :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '章节评价表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_comment_info_inc/';
```

### 1.2.7 ods_favor_info_inc	收藏表

```mysql
DROP TABLE IF EXISTS ods_favor_info_inc;
CREATE EXTERNAL TABLE ods_favor_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,course_id :STRING,user_id :STRING, create_time :STRING,update_time :STRING,deleted
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '收藏表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_favor_info_inc/';
```

### 1.2.8 ods_order_detail_inc	订单明细表

```mysql
DROP TABLE IF EXISTS ods_order_detail_inc;
CREATE EXTERNAL TABLE ods_order_detail_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,course_id :STRING,course_name :STRING,order_id :STRING,user_id :STRING,origin_amount
                  :DECIMAL(16, 2),coupon_reduce
                  :DECIMAL(16, 2),final_amount :DECIMAL(16, 2),session_id :STRING, create_time :STRING,update_time
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '订单明细表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_order_detail_inc/';
```

### 1.2.9 ods_order_info_inc	订单表

```mysql
DROP TABLE IF EXISTS ods_order_info_inc;
CREATE EXTERNAL TABLE ods_order_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,user_id :STRING,origin_amount
                  :DECIMAL(16, 2),coupon_reduce
                  :DECIMAL(16, 2),final_amount :DECIMAL(16, 2),order_status :STRING,out_trade_no :STRING,
                  trade_body
                  :STRING,session_id :STRING, province_id :STRING,create_time :STRING,expire_time :STRING,update_time
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '订单表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_order_info_inc/';
```

### 1.2.10 ods_payment_info_inc	支付表

```mysql
DROP TABLE IF EXISTS ods_payment_info_inc;
CREATE EXTERNAL TABLE ods_payment_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,out_trade_no :STRING,order_id :STRING,alipay_trade_no
                  :STRING,total_amount :DECIMAL(16, 2),trade_body :STRING,payment_type :STRING,payment_status :STRING,create_time
                  :STRING,update_time :STRING,callback_content :STRING,callback_time :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '支付表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_payment_info_inc/';
```

### 1.2.11 ods_review_info_inc	课程评价表

```mysql
DROP TABLE IF EXISTS ods_review_info_inc;
CREATE EXTERNAL TABLE ods_review_info_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,user_id :STRING, course_id :STRING, review_txt :STRING,review_stars :STRING, create_time
                  :STRING, deleted :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '课程评价表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_review_info_inc/';
```

### 1.2.12 ods_test_exam_question_inc	测验问题表

```mysql
DROP TABLE IF EXISTS ods_test_exam_question_inc;
CREATE EXTERNAL TABLE ods_test_exam_question_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,exam_id :STRING,paper_id :STRING,question_id :STRING,user_id :STRING, answer :STRING,is_correct
                  :STRING,score :DECIMAL(16, 2),create_time :STRING, update_time :STRING,deleted :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '测验问题表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_test_exam_question_inc/';
```

### 1.2.13 ods_test_point_question_inc	知识点问题表

```mysql
DROP TABLE IF EXISTS ods_test_point_question_inc;
CREATE EXTERNAL TABLE ods_test_point_question_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,point_id :STRING,question_id :STRING, create_time :STRING,publisher_id :STRING, deleted
                  :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '知识点问题表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_test_point_question_inc/';
```

### 1.2.14 ods_user_chapter_process_inc	用户章节进度表

```mysql
DROP TABLE IF EXISTS ods_user_chapter_process_inc;
CREATE EXTERNAL TABLE ods_user_chapter_process_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,course_id :STRING,chapter_id :STRING,user_id :STRING,position_sec :STRING, create_time
                  :STRING,update_time :STRING, deleted :STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '用户章节进度表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_user_chapter_process_inc/';

```

### 1.2.15 ods_test_exam_inc	测验表

```mysql
DROP TABLE IF EXISTS ods_test_exam_inc;
CREATE EXTERNAL TABLE ods_test_exam_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,paper_id :STRING,user_id :STRING,score :DECIMAL(16, 2),duration_sec :BIGINT,create_time :STRING,submit_time
                  :STRING,update_time :STRING,deleted:STRING> COMMENT '数据',
    `old`  MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '测验表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/edu/ods/ods_test_exam_inc/';
```

# 二、DIM层(总计5张表)

### 2.1 dim_paper_full        试卷维度表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dim_paper_full;
CREATE EXTERNAL TABLE dim_paper_full
(
    paper_id            STRING COMMENT '试卷编号',
    paper_title   STRING COMMENT '试卷名称',
    course_id     STRING COMMENT '课程id',
    course_name   STRING COMMENT '课程名称',
    subject_id    STRING COMMENT '学科id',
    subject_name   STRING COMMENT '学科名称',
    category_id   STRING COMMENT '品类id',
    category_name   STRING COMMENT '品类名称',
    question_id   STRING COMMENT '问题id',
    question_type STRING COMMENT '问题类型',
    question_txt STRING COMMENT '问题内容',
    is_correct STRING COMMENT '是否正确',
    create_time   STRING COMMENT '创建时间',
    update_time   STRING COMMENT '更新时间',
    publisher_id  STRING COMMENT '发布者id',
    deleted       STRING COMMENT '是否删除'
) comment '试卷维度表'
    partitioned by (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dim/dim_paper_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
with paper as (
    select id,
           paper_title,
           course_id,
           create_time,
           update_time,
           publisher_id,
           deleted,
           dt
    from ods_test_paper_full
    where dt = '2022-02-25'
),
     course as (
         select id,
                course_name,
                subject_id
         from ods_course_info_full
         where dt = '2022-02-25'
     ),
     sub as (
         select id,
                subject_name,
                category_id
         from ods_base_subject_info_full
         where dt = '2022-02-25'
     ),
     cate as (
         select id,
                category_name
         from ods_base_category_info_full
            where dt = '2022-02-25'
     ),
     question as (
         select id,
                chapter_id,
                question_type,
                question_txt,
                course_id
         from ods_test_question_info_full
            where dt = '2022-02-25'
     ),q_option as (
         select data.question_id,
                data.is_correct
         from ods_test_question_option_inc
         where dt = '2022-02-25'
)
insert overwrite table dim_paper_full partition (dt='2022-02-25')
select paper.id,
       paper_title,
       paper.course_id,
       course_name,
       course.subject_id,
       sub.subject_name,
       sub.category_id,
       cate.category_name,
       question.id,
       question.question_type,
        question_txt,
       is_correct,
       create_time,
       update_time,
       publisher_id,
       deleted
from paper
         left join course on paper.course_id = course.id
         left join sub on course.subject_id = sub.id
         left join cate on sub.category_id = cate.id
         left join question on paper.course_id = question.course_id
left join q_option on question.id = q_option.question_id
```

### 2.2 dim_course_full        课程维度表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dim_course_full;
create external table dim_course_full
(
    `course_id`     STRING comment '课程id',
    `course_name`   string comment '课程名称',
    `subject_id`    string comment '学科id',
    `subject_name`  string comment '学科名称',
    `category_id`   string comment '分类id',
    `category_name` string comment '分类名称',
    `chapter_num`   string comment '章节数',
    `chapter_id`    string comment '章节id',
    `chapter_name`  string comment '章节名称',
    `is_free`       string comment '本章节是否免费',
    `teacher`       string comment '讲师名称',
    `origin_price`  string comment '价格',
    `reduce_amount` string comment '优惠价格',
    `actual_price`  string comment '实际价格',
    `create_time`   string comment '创建时间',
    `update_time`   string comment '更新时间',
    `deleted`       string comment '是否删除'
) comment '课程维度表'
    partitioned by (`dt` string)
    stored as orc
    location '/warehouse/edu/dim/dim_course_full/'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
  insert overwrite table dim_course_full partition(dt='2022-02-25')
select
     course.course_id    `course_id`  	 --STRING comment '课程id',
     , `course_name`                     --string comment '课程名称',
     , course.subject_id   `subject_id`  --string comment '学科id',
     , `subject_name`                    --string comment '学科名称',
     , subject.category_id `category_id` --string comment '分类id',
     , `category_name`                   --string comment '分类名称',
     , `chapter_num`                     --string comment '章节数',
     , `chapter_id`                      --string comment '章节id',
     , `chapter_name`                    --string comment '章节名称',
     , `is_free`                         --string comment '本章节是否免费',
     , `teacher`                         --string comment '讲师名称',
     , `origin_price`                    --string comment '价格',
     , `reduce_amount`                   --string comment '优惠价格',
     , `actual_price`                    --string comment '实际价格',
     , `create_time`                     --string comment '创建时间',
     , `update_time`                     --string comment '更新时间',
     , `deleted`                         --string comment '是否删除'
from
(
    select
        id course_id,
        course_name,
        subject_id,
        teacher,
        chapter_num,
        origin_price,
        reduce_amount,
        actual_price,
        create_time,
        update_time,
        deleted
    from ods_course_info_full
    where dt = '2022-02-25'
) course
left join
(
    select id subject_id,
           subject_name,
           category_id
    from ods_base_subject_info_full
    where dt = '2022-02-25'
) subject on subject.subject_id = course.subject_id
left join
(
    select id category_id,
           category_name
    from ods_base_category_info_full
    where dt = '2022-02-25'
) category on category.category_id = subject.category_id
left join
(
    select
       id chapter_id,
       chapter_name,
       is_free,
       course_id
    from ods_chapter_info_full
    where dt = '2022-02-25'
) chapter on chapter.course_id = course.course_id;
```

### 2.3 dim_user_zip	用户维度表

#### 1 建表语句

```mysql
-- dim_user_zip 建表
DROP TABLE IF EXISTS dim_user_zip;
CREATE EXTERNAL TABLE dim_user_zip
(
    `id`           STRING COMMENT '用户id',
    `login_name`   STRING COMMENT '用户名称',
    `nick_name`    STRING COMMENT '用户昵称',
    `passwd`       STRING COMMENT '用户密码',
    `real_name`    STRING COMMENT '用户姓名',
    `phone_num`    STRING COMMENT '手机号码',
    `email`        STRING COMMENT '邮箱',
    `head_img`     STRING COMMENT '头像',
    `user_level`   STRING COMMENT '用户级别',
    `birthday`     STRING COMMENT '生日',
    `gender`       STRING COMMENT '性别 M F',
    `create_time`  STRING COMMENT '创建时间',
    `operate_time` STRING COMMENT '修改时间',
    `status`       STRING COMMENT '状态',
    `start_date`   STRING COMMENT '开始日期',
    `end_date`     STRING COMMENT '结束日期'
) COMMENT '用户表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dim/dim_user_zip/'
    TBLPROPERTIES ('orc.compress' = 'snappy');

```

#### 2 首日导数语句

```mysql
-- 首次导入 用户表
insert overwrite table dim_user_zip partition (dt='9999-12-31')
select
    data.id,
    data.login_name,
    data.nick_name,
    md5(data.passwd) passwd,
    md5(data.real_name) real_name,
    md5(if(data.phone_num regexp '^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\\d{8}$',data.phone_num,null)) phone_num,
    md5(if(data.email regexp '^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$',data.email,null)) email,
    data.head_img,
    data.user_level,
    data.birthday,
    data.gender,
    data.create_time,
    data.operate_time,
    data.status,
    '2022-02-25' start_date,
    '9999-12-31' end_date
from ods_user_info_inc
where dt='2022-02-25'
and type='bootstrap-insert';
```

```mysql
insert overwrite table dim_user_zip partition (dt='9999-12-31')
select data.id,
       data.login_name,
       data.nick_name,
       data.passwd,
       data.real_name,
       data.phone_num,
       data.email,
       data.head_img,
       data.user_level,
       data.birthday,
       data.gender,
       data.create_time,
       data.operate_time,
       data.status,
       '2022-02-25' start_date,
       '9999-12-31' end_date
from ods_user_info_inc
where dt = '2022-02-25'
  and type = 'bootstrap-insert';
```

#### 3 每日导数语句 

```mysql
insert overwrite table dim_user_zip partition(dt)
select
    id,
    login_name,
    nick_name,
    passwd,
    real_name,
    phone_num,
    email,
    head_img,
    user_level,
    birthday,
    gender,
    create_time,
    operate_time,
    status,
    start_date,
    if(rn=2,date_sub('2022-02-26',1),end_date) end_date,
    if(rn=1,'9999-12-31',date_sub('2022-02-26',1)) dt
from
(
    select
        id,
        login_name,
        nick_name,
        passwd,
        real_name,
        phone_num,
        email,
        head_img,
        user_level,
        birthday,
        gender,
        create_time,
        operate_time,
        status,
        start_date,
        end_date,
        row_number() over (partition by id order by start_date desc) rn
    from
    (
        select
            id,
            login_name,
            nick_name,
            passwd,
            real_name,
            phone_num,
            email,
            head_img,
            user_level,
            birthday,
            gender,
            create_time,
            operate_time,
            status,
            start_date,
            end_date
        from dim_user_zip
        where dt='9999-12-31'
        union
        select
           id,
           login_name,
           nick_name,
           passwd,
           real_name,
           phone_num,
           email,
           head_img,
           user_level,
           birthday,
           gender,
           create_time,
           operate_time,
           status,
           '2022-02-26' start_date,
           '9999-12-31' end_date
        from
        (
            select
               data.id,
               data.login_name,
               data.nick_name,
               data.passwd,
               data.real_name,
               data.phone_num,
               data.email,
               data.head_img,
               data.user_level,
               data.birthday,
               data.gender,
               data.create_time,
               data.operate_time,
               data.status,
               row_number() over (partition by data.id order by ts desc) rn
            from ods_user_info_inc
            where dt='2022-02-26'
        )t1
        where rn=1
    )t2
)t3;
```

### 2.4 dim_video_full        视频信息维度表

#### 1 建表语句

```mysql
drop table if exists dim_video_full;
create external table dim_video_full
(
    id               string comment 'id',
    video_name       string comment '视频名称',
    video_during_sec bigint comment '视频时长',
    video_size       string comment '视频大小',
    video_source_id  string comment '视频云端编号',
    chapter_id       string comment '章节id',
    chapter_name     string comment '章节名称',
    course_id        string comment '课程id',
    course_name      string comment '课程名称',
    subject_id       string comment '学科id',
    subject_name     string comment '学科名称',
    category_id      string comment '分类id',
    category_name    string comment '学科分类名',
    teacher          string comment '教师名',
    create_time      string comment '创建时间',
    update_time      string comment '更新时间'
) COMMENT '视频信息表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dim/dim_province_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
insert overwrite table dim_video_full partition (dt = '2022-02-25')
select v.id,
       video_name,
       during_sec video_during_sec,
       video_size,
       video_source_id,
       v.chapter_id,
       c.chapter_name,
       v.course_id,
       cs.course_name,
       cs.subject_id,
       s.subject_name,
       s.category_id,
       category_name,
       teacher,
       v.create_time,
       v.update_time
from (select id,
             video_name,
             during_sec,
             video_size,
             video_source_id,
             chapter_id,
             course_id,
             create_time,
             update_time
      from ods_video_info_full
      where dt = '2022-02-25') v
         left join (select id, chapter_name from ods_chapter_info_full where dt = '2022-02-25') c on v.chapter_id = c.id
         left join (select id, course_name, subject_id, teacher from ods_course_info_full where dt = '2022-02-25') cs
                   on v.course_id = cs.id
         left join (select id, subject_name, category_id from ods_base_subject_info_full where dt = '2022-02-25') s
                   on cs.subject_id = s.id
         left join (select id, category_name from ods_base_category_info_full where dt = '2022-02-25') ct;
```

### 2.5 dim_province_full        地区维度表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dim_province_full;
CREATE EXTERNAL TABLE dim_province_full
(
    `id`            STRING COMMENT 'id',
    `province_name` STRING COMMENT '省市名称',
    `area_code`     STRING COMMENT '地区编码',
    `iso_code`      STRING COMMENT '旧版ISO-3166-2编码，供可视化使用',
    `iso_3166_2`    STRING COMMENT '新版IOS-3166-2编码，供可视化使用',
    `region_id`     STRING COMMENT '地区id'
) COMMENT '地区维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/gmall/dim/dim_province_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
insert overwrite table dim_province_full partition (dt='2022-02-25')
select id,
       name,
       area_code,
       iso_code,
       iso_3166_2,
       region_id
from ods_base_province_full
where dt = '2022-02-25';
```

### 2.6 dim_exam_full        考试/测试维度表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dim_exam_full;
CREATE EXTERNAL TABLE dim_exam_full
(
    `exam_id`                  STRING COMMENT '测试id',
    `paper_title`              STRING COMMENT '测试名称',
    `user_id`                  STRING COMMENT '用户id',
    `paper_id`                 STRING COMMENT '考卷id',
    `course_id`                STRING COMMENT '课程id',
    `score`                    DECIMAL(16, 2) COMMENT '测试分数',
    `duration_sec`             BIGINT COMMENT '所用时长',
    `create_time`              STRING COMMENT '开始时间',
    `submit_time`              STRING COMMENT '提交时间',
    `update_time`              STRING COMMENT '修改时间',
    `deleted`                  STRING COMMENT '是否删除',
    `exam_question_id`         STRING COMMENT '考题id',
    `exam_question_answer`     STRING COMMENT '考题答案',
    `exam_question_is_correct` STRING COMMENT '考题是否正确',
    `exam_question_score`      DECIMAL(16, 2) COMMENT '本题得分'
) COMMENT '商品维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dim/dim_exam_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
insert overwrite table dim_exam_full partition(dt='2022-02-25')
select
    `exam_id`                  --STRING COMMENT '测试id',
    ,`paper_title`              --STRING COMMENT '测试名称',
    ,`user_id`                  --STRING COMMENT '用户id',
    ,exam.paper_id `paper_id`                 --STRING COMMENT '考卷id',
    ,`course_id`                --STRING COMMENT '课程id',
    ,`score`                    --DECIMAL(16, 2) COMMENT '测试分数',
    ,`duration_sec`             --BIGINT COMMENT '所用时长',
    ,`create_time`              --STRING COMMENT '开始时间',
    ,`submit_time`              --STRING COMMENT '提交时间',
    ,`update_time`              --STRING COMMENT '修改时间',
    ,`deleted`                  --STRING COMMENT '是否删除',
    ,`exam_question_id`         --STRING COMMENT '考题id',
    ,`exam_question_answer`     --STRING COMMENT '考题答案',
    ,`exam_question_is_correct` --STRING COMMENT '考题是否正确',
    ,`exam_question_score`      --DECIMAL(16, 2) COMMENT '本题得分'
from (
    select
        data.id,
        data.paper_id,
        data.user_id,
        data.score,
        data.duration_sec,
        data.create_time,
        data.submit_time,
        data.update_time,
        data.deleted
    from ods_test_exam_inc
    where dt = '2022-02-25'
    and type = 'bootstrap-insert'
) exam
left join (
    select
       data.exam_id,
       data.paper_id,
       data.question_id exam_question_id,
       data.answer exam_question_answer,
       data.is_correct exam_question_is_correct,
       data.score exam_question_score
    from ods_test_exam_question_inc
    where dt = '2022-02-25'
    and type = 'bootstrap-insert'
) exam_question on exam.id = exam_question.exam_id
left join (
    select id,
           paper_title,
           course_id
    from ods_test_paper_full
    where dt = '2022-02-25'
) paper on paper.id = exam.paper_id
```



# 三、DWD层（总计17张表）

## 3.1 交易域（总计4张表）

### 3.1.1 dwd_trade_cart_add_inc        加购购物车事务事实表

#### 1.建表语句

```mysql
drop table if exists dwd_trade_cart_add_inc;
create external table dwd_trade_cart_add_inc
(
    `id`          string comment '编号',
    `user_id`     string comment '用户id',
    `course_id`   string comment '课程id',
    `course_name` string comment '课程名称',
    `cart_price`  string comment '放入购物车时价格',
    `session_id`  string comment '会话id',
    `date_id`     string comment '加购时间',
    `create_time` string comment '创建时间',
    `update_time` string comment '修改时间',
    `deleted`     string comment '是否删除',
    `sold`        string comment '是否已售'
) comment '交易域加购购物车事务事实表'
    partitioned by (`dt` string)
    stored as orc
    location '/warehouse/edu/dwd/dwd_trade_cart_add_inc'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_trade_cart_add_inc partition (dt)
select
    id,
    user_id,
    course_id,
    course_name,
    cart_price,
    session_id,
    date_format(create_time, 'yyyy-MM-dd') date_id,
    create_time,
    update_time,
    deleted,
    sold,
    date_format(create_time, 'yyyy-MM-dd') dt
from (
   select
        data.id,
        data.user_id,
        data.course_id,
        data.course_name,
        data.cart_price,
        data.session_id,
        data.create_time,
        data.update_time,
        data.deleted,
        data.sold
    from ods_cart_info_inc
    where dt='2022-02-25'
    and type='bootstrap-insert'
) t1;
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_trade_cart_add_inc partition(dt='2022-02-26')
select
    id,
    user_id,
    course_id,
    course_name,
    cart_price,
    session_id,
    date_format(create_time, 'yyyy-MM-dd') date_id,
    create_time,
    update_time,
    deleted,
    sold
from
(
    select
        data.id,
        data.user_id,
        if(old['deleted'] = 1,'null',data.course_id) course_id,
        data.course_name,
        data.cart_price,
        data.session_id,
        date_format(from_utc_timestamp(ts*1000,'GMT+8'),'yyyy-MM-dd') date_id,
        date_format(from_utc_timestamp(ts*1000,'GMT+8'),'yyyy-MM-dd HH:mm:ss') create_time,
        data.update_time,
        data.deleted,
        data.sold
    from ods_cart_info_inc
    where dt='2022-02-26'
    and type='insert'
)cart;
```

### 3.1.2 dwd_trade_order_detail_inc         交易域下单明细事务事实表

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS dwd_trade_order_detail_inc;
CREATE EXTERNAL TABLE dwd_trade_order_detail_inc
(
    `order_id`       STRING COMMENT '订单id',
    `user_id`        STRING COMMENT '用户id',
    `course_id`      STRING COMMENT '课程id',
    `province_id`    STRING COMMENT '省份id',
    `order_status`   STRING COMMENT '订单状态',
    `create_time`    STRING COMMENT '下单时间',
    `order_date`     STRING COMMENT '下单日期',
    `update_time`    STRING COMMENT '更新时间',
    `payment_time`   STRING COMMENT '支付时间',
    `payment_type`   STRING COMMENT '支付类型',
    `payment_status` STRING COMMENT '支付状态',
    `origin_amount`  DECIMAL(16, 2) COMMENT '原始价格',
    `coupon_reduce`  DECIMAL(16, 2) COMMENT '优惠卷减免',
    `final_amount`   DECIMAL(16, 2) COMMENT '最终金额'
) COMMENT '交易域下单明细事务事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_trade_order_detail_inc/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_trade_order_detail_inc partition (dt)
select odd.order_id,
       odd.user_id,
       odd.course_id,
       od.province_id,
       od.order_status,
       odd.create_time,
       odd.order_date,
       odd.update_time,
       pay.pay_time,
       pay.payment_type,
       pay.payment_status,
       odd.origin_amount,
       odd.coupon_reduce,
       odd.final_amount,
       date_format(odd.create_time,'yyyy-MM-dd')
from (
     select data.order_id,
            data.user_id,
            data.course_id,
            data.origin_amount,
            data.coupon_reduce,
            data.final_amount,
            date_format(data.create_time,'yyyy-MM-dd') order_date,
            data.create_time,
            data.update_time
    from ods_order_detail_inc
    where dt = '2022-02-25'
    and type = 'bootstrap-insert'
 ) odd
left join (
    select data.id,
           data.province_id,
           data.order_status
    from ods_order_info_inc
    where dt = '2022-02-25'
    and type = 'bootstrap-insert'
) od on odd.order_id = od.id
left join (
    select data.order_id,
           data.create_time,
           data.payment_type,
           data.payment_status,
           date_format(data.create_time,'yyyy-MM-dd') `pay_time`
    from ods_payment_info_inc
    where dt = '2022-02-25'
    and type = 'bootstrap-insert'
) pay on od.id = pay.order_id;
```

#### 3.每日数据装载

```mysql
insert overwrite table dwd_trade_order_detail_inc partition (dt='2022-02-26')
select odd.order_id,
       odd.user_id,
       odd.course_id,
       od.province_id,
       od.order_status,
       odd.create_time,
       odd.order_date,
       odd.update_time,
       pay.pay_time,
       pay.payment_type,
       pay.payment_status,
       odd.origin_amount,
       odd.coupon_reduce,
       odd.final_amount
from (
     select data.order_id,
            data.user_id,
            data.course_id,
            data.origin_amount,
            data.coupon_reduce,
            data.final_amount,
            date_format(data.create_time,'yyyy-MM-dd') order_date,
            data.create_time,
            data.update_time
    from ods_order_detail_inc
    where dt = '2022-02-26'
    and type = 'insert'
 ) odd
left join (
    select data.id,
           data.province_id,
           data.order_status
    from ods_order_info_inc
    where dt = '2022-02-26'
    and type = 'insert'
) od on odd.order_id = od.id
left join (
    select data.order_id,
           data.create_time,
           data.payment_type,
           data.payment_status,
           date_format(data.create_time,'yyyy-MM-dd') `pay_time`
    from ods_payment_info_inc
    where dt = '2022-02-26'
    and type = 'insert'
) pay on od.id = pay.order_id;
```

### 3.1.3.dwd_trade_pay_detail_suc_inc          交易域成功支付事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_trade_pay_detail_suc_inc;
CREATE EXTERNAL TABLE dwd_trade_pay_detail_suc_inc
(
    `id`                    STRING COMMENT '编号',
    `out_trade_no`              STRING COMMENT '对外业务编号',
    `order_id`              STRING COMMENT '订单编号',
    `user_id`               STRING COMMENT '用户Sid',
    `course_id`                STRING COMMENT '课程id',
    `course_name`           STRING COMMENT '课程名称',
    `trade_body`             STRING COMMENT '交易内容',
    `payment_type`             STRING COMMENT '支付类型',
    `alipay_trade_no`           STRING COMMENT '支付交易编号',
    `total_amount`      STRING COMMENT '支付金额',
    `pay_time`         STRING COMMENT '支付时间',
    `callback_time`         STRING COMMENT '支付成功时间',
    `update_time`  STRING COMMENT '更新时间'
) COMMENT '交易域成功支付事务事实表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_trade_pay_detail_suc_inc/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_trade_pay_detail_suc_inc partition (dt)
select pay_success.id,
       pay_success.out_trade_no,
       pay_success.order_id,
       od.user_id,
       od.course_id,
       od.course_name,
       pay_success.trade_body,
       pay_success.payment_type,
       pay_success.alipay_trade_no,
       pay_success.total_amount,
       pay_success.create_time,
       pay_success.callback_time,
       pay_success.update_time,
       date_format(create_time,'yyyy-MM-dd')
from (
     select data.id,
       data.order_id,
           data.payment_type,
       data.out_trade_no,
       data.trade_body,
       data.alipay_trade_no,
       data.total_amount,
            data.callback_time,
            data.update_time,data.create_time
from ods_payment_info_inc
where dt = '2022-02-25'
    and type = 'bootstrap-insert'
         )pay_success left join (
              select
            data.user_id,
            data.order_id,
            data.course_id,
            data.course_name,
            data.update_time
        from ods_order_detail_inc
        where dt = '2022-02-25'
             and type = 'bootstrap-insert'
    )od on pay_success.order_id = od.order_id;
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_trade_pay_detail_suc_inc partition (dt='2022-02-26')
select pay_success.id,
       pay_success.out_trade_no,
       pay_success.order_id,
       od.order_id,
       od.course_id,
       od.course_name,
       pay_success.trade_body,
       pay_success.payment_type,
       pay_success.alipay_trade_no,
       pay_success.total_amount,
       pay_success.create_time,
       pay_success.callback_time,
       pay_success.update_time
from (
     select data.id,
       data.order_id,
           data.payment_type,
       data.out_trade_no,
       data.trade_body,
       data.alipay_trade_no,
       data.total_amount,
            data.callback_time,
            data.update_time,
            data.create_time
from ods_payment_info_inc
where dt = '2022-02-26'
    and type = 'insert'
         )pay_success left join (
              select
            data.user_id,
            data.order_id,
            data.course_id,
            data.course_name,
            data.update_time
        from ods_order_detail_inc
        where dt = '2022-02-26'
             and type = 'insert'
    )od on pay_success.order_id = od.order_id;
```

### 3.1.4 dwd_trade_cart_info_full          购物车周期快照表

#### 1.建表语句

```mysql
drop table if exists dwd_trade_cart_info_full;
create external table dwd_trade_cart_info_full
(
    user_id     string comment '用户id',
    course_id   string comment '课程id',
    course_name string comment '课程名称',
    cart_price  decimal(16, 2) comment '购物车总额',
    create_time string comment '创建时间',
    update_time string comment '更新时间',
    sold        string comment '是否已售'
) comment '购物车周期快照表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dwd/dwd_trade_cart_info_full'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 每日导数语句

```mysql
insert overwrite table dwd_trade_cart_info_full partition (dt='2022-02-25')
select user_id,
       course_id,
       course_name,
       cart_price,
       create_time,
       update_time,
       sold
from ods_cart_info_full
where dt = '2022-02-25';
```

## 3.2 学习域（总计4张表）

### 3.2.1 dwd_study_test_inc         学习域考试表

#### 1 建表语句

```mysql
drop table if exists dwd_exam_user_exam_inc;
create table dwd_exam_user_exam_inc
(
    exam_id        string comment '考试编号',
    user_id        string comment '用户id',
    papar_id       string comment '试卷id',
    score          bigint comment '测试成绩',
    duration_sec   bigint comment '考试用时',
    question_id    string comment '问题编号',
    is_correct     string comment '答题正误',
    question_score string comment '问题得分',
    submit_time    string comment '试卷提交时间'


) comment '学习域考试事实表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dwd/dwd_user_exam_inc'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
select exam_id,
       user_id,
       paper_id,
       exam.score,
       exam.duration_sec,
       question_id,
       is_correct,
       question.score question_score,
       submit_time    submit_time
from (
         select data.id,
                data.user_id,
                data.paper_id,
                data.score,
                data.duration_sec,
                data.submit_time
         from ods_test_exam_inc
         where dt = '2022-02-25'
           and type = 'bootstrap-insert'
     ) exam
         left join
     (
         select data.exam_id,
                data.question_id,
                data.is_correct,
                data.score
         from ods_test_exam_question_inc
         where dt = '2022-02-25'
           and type = 'bootstrap-insert'
     ) question on exam.id = question.exam_id;
```

#### 3 每日导数语句

```mysql
select exam_id,
       user_id,
       paper_id,
       exam.score,
       exam.duration_sec,
       question_id,
       is_correct,
       question.score question_score,
       submit_time    submit_time
from (
         select data.id,
                data.user_id,
                data.paper_id,
                data.score,
                data.duration_sec,
                data.submit_time
         from ods_test_exam_inc
         where dt = '2022-02-26'
           and type = 'insert'
     ) exam
         left join
     (
         select data.exam_id,
                data.question_id,
                data.is_correct,
                data.score
         from ods_test_exam_question_inc
         where dt = '2022-02-26'
           and type = 'insert'
     ) question on exam.id = question.exam_id;
```



### 3.2.2 dwd_study_user_chapter_process_acc         用户进度累积快照事实表

#### 1 建表语句

```mysql
drop table if exists dwd_study_user_chapter_process;
create external table dwd_study_user_chapter_process
(
    user_id              string comment '用户id',
    video_id             string comment '视频id',
    time_acc             bigint comment '累积播放时长',
    position_sec         bigint comment '当前视频进度',
    first_time           string comment '首次观看日期',
    last_time            string comment '上次观看日期',
    acc_finish_date      string comment '累积时长达标时间',
    position_finish_date string comment '播放进度达标时间',
    finish_time          string comment '完播日期'
) comment '用户进度累积快照事实表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dwd/dwd_study_user_chapter_process_inc'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_study_user_chapter_process partition (dt = '9999-12-31')
select *,
       if(acc_finish_date = '9999-12-31' or position_finish_date = '9999-12-31', '9999-12-31', '2022-02-25') finish_date
from (
         select distinct user_id,
                         vi.id                                                         video_id,
                         time_acc,
                         position_sec,
                         first_time,
                         last_time,
                         if(time_acc >= cast(during_sec as bigint) * 0.9, last_time, '9999-12-31')     acc_finish_date,
                         if(position_sec >=cast(during_sec as bigint) * 0.9, last_time, '9999-12-21') position_finish_date
         from (
                  select common.uid                                 user_id,
                         appvideo.video_id,
                         sum(appvideo.play_sec)                     time_acc,
                         max(cast(appvideo.position_sec as bigint)) position_sec,
                         '2022-02-25'                               first_time,
                         '2022-02-25'                               last_time
                  from ods_log_inc
                  where dt = '2022-02-25'
                    and appvideo.video_id is not null
                  group by common.uid, appvideo.video_id
              ) process
                  join ods_video_info_full vi on process.video_id = vi.id
     ) t;

```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_study_user_chapter_process partition (dt)
select user_id,
       video_id,
       sum(time_acc)             time_acc,
       max(position_sec)         posititon_sec,
       min(first_time)           first_time,
       max(last_time)            last_time,
       min(acc_finish_date)      acc_finish_date,
       min(position_finish_date) position_finish_date,
       min(finish_time)          finish_time,
       min(finish_time)          finish_time

from (
         select user_id,
                video_id,
                time_acc,
                position_sec,
                first_time,
                last_time,
                acc_finish_date,
                position_finish_date,
                finish_time
         from dwd_study_user_chapter_process
         where dt = '9999-12-31'
         union all
         select *,
                if(acc_finish_date = '9999-12-31' or position_finish_date = '9999-12-31', '9999-12-31',
                   '2022-02-26') finish_date
         from (
                  select distinct user_id,
                                  vi.id                        video_id,
                                  time_acc,
                                  cast(position_sec as bigint) position_sec,
                                  first_time,
                                  last_time,
                                  if(time_acc  >= cast(during_sec as bigint) * 0.9, last_time,
                                     '9999-12-31')             acc_finish_date,
                                  if(position_sec >= cast(during_sec as bigint) * 0.9, last_time,
                                     '9999-12-21')             position_finish_date
                  from (
                           select common.uid                                 user_id,
                                  appvideo.video_id,
                                  sum(appvideo.play_sec)                     time_acc,
                                  max(cast(appvideo.position_sec as bigint)) position_sec,
                                  '2022-02-26'                               first_time,
                                  '2022-02-26'                               last_time
                           from ods_log_inc
                           where dt = '2022-02-26'
                             and appvideo.video_id is not null
                           group by common.uid, appvideo.video_id
                       ) process
                           join ods_video_info_full vi on process.video_id = vi.id
              ) t
     ) tmp
group by user_id, video_id;
```

### 3.2.3 dwd_study_video_per_day_inc         学习域每日视频观看快照表

#### 1 建表语句

```mysql
drop table if exists dwd_study_video_per_day_inc;
create external table dwd_study_video_per_day_inc
(
    user_id           string comment '用户id',
    video_id          string comment '视频id',
    total_time        bigint comment '当日累积观看时长',
    max_time_position bigint comment '当日最大视频进度',
    first_time        string comment '首日观看时间'
) comment '学习域每日视频观看快照表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dwd/dwd_study_video_per_day_inc'
    tblproperties ('orc.compress' = 'snappy');

```

#### 2 每日导数语句

```mysql
insert overwrite table dwd_study_video_per_day_inc partition (dt = '2022-02-25')
select common.uid                                 user_id,
       appvideo.video_id,
       sum(appvideo.play_sec)                     total_time,
       max(cast(appvideo.position_sec as bigint)) max_time_position,
       '2022-02-25'                               first_time
from ods_log_inc
where dt = '2022-02-25'
  and appvideo.video_id is not null
group by common.uid, appvideo.video_id;
```

### 3.2.4 dwd_exam_user_exam_inc         学习域考试事实表

#### 1 建表语句

```mysql
drop table if exists dwd_exam_user_exam_inc;
create external table dwd_exam_user_exam_inc
(
    exam_id        string comment '考试编号',
    user_id        string comment '用户id',
    papar_id       string comment '试卷id',
    score          bigint comment '测试成绩',
    duration_sec   bigint comment '考试用时',
    question_id    string comment '问题编号',
    is_correct     string comment '答题正误',
    question_score string comment '问题得分',
    submit_time    string comment '试卷提交时间'


) comment '学习域考试事实表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dwd/dwd_user_exam_inc'
    tblproperties ('orc.compress' = 'snappy');

```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_exam_user_exam_inc partition (dt = '2022-02-25')
select exam_id,
       user_id,
       paper_id,
       exam.score,
       exam.duration_sec,
       question_id,
       is_correct,
       question.score question_score,
       submit_time    submit_time
from (
         select data.id,
                data.user_id,
                data.paper_id,
                data.score,
                data.duration_sec,
                data.submit_time
         from ods_test_exam_inc
         where dt = '2022-02-25'
           and type = 'bootstrap-insert'
     ) exam
         left join
     (
         select data.exam_id,
                data.question_id,
                data.is_correct,
                data.score
         from ods_test_exam_question_inc
         where dt = '2022-02-25'
           and type = 'bootstrap-insert'
     ) question on exam.id = question.exam_id;
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_exam_user_exam_inc partition (dt = '2022-02-26')
select exam_id,
       user_id,
       paper_id,
       exam.score,
       exam.duration_sec,
       question_id,
       is_correct,
       question.score question_score,
       submit_time    submit_time
from (
         select data.id,
                data.user_id,
                data.paper_id,
                data.score,
                data.duration_sec,
                data.submit_time
         from ods_test_exam_inc
         where dt = '2022-02-26'
           and type = 'insert'
     ) exam
         left join
     (
         select data.exam_id,
                data.question_id,
                data.is_correct,
                data.score
         from ods_test_exam_question_inc
         where dt = '2022-02-26'
           and type = 'insert'
     ) question on exam.id = question.exam_id;
```

## 3.3流量域（总计5张表）

### 3.3.1dwd_traffic_page_view_inc        流量域页面浏览事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_traffic_page_view_inc;
CREATE EXTERNAL TABLE dwd_traffic_page_view_inc
(
    `province_id`    STRING COMMENT '省份id',
    `brand`          STRING COMMENT '手机品牌',
    `channel`        STRING COMMENT '渠道',
    `is_new`         STRING COMMENT '是否首次启动',
    `model`          STRING COMMENT '手机型号',
    `mid_id`         STRING COMMENT '设备id',
    `operate_system` STRING COMMENT '操作系统',
    `user_id`        STRING COMMENT '会员id',
    `version_code`   STRING COMMENT 'app版本号',
    `page_item`      STRING COMMENT '目标id ',
    `page_item_type` STRING COMMENT '目标类型',
    `last_page_id`   STRING COMMENT '上页类型',
    `page_id`        STRING COMMENT '页面ID ',
    `source_id`    STRING COMMENT '来源id',
    `source_site`    STRING COMMENT '来源名称',
    `source_url`    STRING COMMENT '来源url',
    `date_id`        STRING COMMENT '日期id',
    `view_time`      STRING COMMENT '跳入时间',
    `session_id`     STRING COMMENT '所属会话id',
    `during_time`    BIGINT COMMENT '持续时间毫秒'
) COMMENT '页面日志表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_traffic_page_view_inc'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
insert overwrite table dwd_traffic_page_view_inc partition (dt='2022-02-25')
select
    province_id,
    brand,
    channel,
    is_new,
    model,
    mid_id,
    operate_system,
    user_id,
    version_code,
    page_item,
    page_item_type,
    last_page_id,
    page_id,
    source_id,
    source_site,
    source_url,
    date_format(from_utc_timestamp(ts,'GMT+8'),'yyyy-MM-dd') date_id,
    date_format(from_utc_timestamp(ts,'GMT+8'),'yyyy-MM-dd HH:mm:ss') view_time,
    concat(mid_id,'-',last_value(session_start_point,true) over (partition by mid_id order by ts)) session_id,
    during_time
from
(
    select
        concat(common.ar,'0000') area_code,
        common.ba brand,
        common.ch channel,
        common.is_new is_new,
        common.md model,
        common.mid mid_id,
        common.os operate_system,
        common.uid user_id,
        common.vc version_code,
        page.during_time,
        page.item page_item,
        page.item_type page_item_type,
        page.last_page_id,
        page.page_id,
        ts,
        if(page.last_page_id is null,ts,null) session_start_point
    from ods_log_inc
    where dt='2022-02-25'
    and page is not null
)log
left join
(
    select
        id province_id,
        area_code
    from ods_base_province_full
    where dt='2022-02-25'
)bp
on log.area_code=bp.area_code
left join
(
    select
        id source_id,
        source_site,
        source_url
    from ods_base_source_full
    where dt='2022-02-25'
) source
```

### 3.3.2 dwd_traffic_start_inc 启动日志表

#### 1 建表语句

```mysql

```

#### 2 每日导数语句

```mysql

```

### 3.3.3 dwd_traffic_action_inc 动作日志表

#### 1 建表语句

```mysql

```

#### 2 每日导数语句

```mysql

```

### 3.3.4 dwd_traffic_display_inc 曝光日志表

#### 1 建表语句

```mysql

```

#### 2 每日导数语句

```mysql

```

### 3.3.5 dwd_traffic_error_inc  流量域错误事务事实表

#### 1 建表语句

```mysql

```

#### 2 每日导数语句

```mysql

```

## 3.4 互动域（总计3张表）

### 3.4.1 dwd_interaction_chapter_comment_inc	章节评价事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_interaction_chapter_comment_inc;
CREATE EXTERNAL TABLE dwd_interaction_chapter_comment_inc
(
    `id`          STRING COMMENT '编号',
    `user_id`     STRING COMMENT '用户ID',
    `chapter_id`  STRING COMMENT '章节ID',
    `course_id`   STRING COMMENT '课程ID',
    `comment_txt` STRING COMMENT '评价内容',
    `date_id`     STRING COMMENT '日期id',
    `create_time` STRING COMMENT '评价时间'
) COMMENT '章节评价事务事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_interaction_chapter_comment_inc/'
    TBLPROPERTIES ("orc.compress" = "snappy");
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_interaction_chapter_comment_inc partition(dt)
select
    data.id,
    data.user_id,
    data.chapter_id,
    data.course_id,
    data.comment_txt,
    date_format(data.create_time,'yyyy-MM-dd') date_id,
    data.create_time,
    date_format(data.create_time,'yyyy-MM-dd')
from ods_comment_info_inc
where dt='2022-02-25'
and type = 'bootstrap-insert';
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_interaction_chapter_comment_inc partition(dt='2022-02-26')
select
    data.id,
    data.user_id,
    data.chapter_id,
    data.course_id,
    data.comment_txt,
    date_format(data.create_time,'yyyy-MM-dd') date_id,
    data.create_time
from ods_comment_info_inc
where dt='2022-02-26'
and type = 'insert';
```



### 3.4.2 dwd_interaction_course_comment_inc	互动域评价课程事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_interaction_course_comment_inc;
CREATE EXTERNAL TABLE dwd_interaction_course_comment_inc
(
    `id`           STRING COMMENT '编号',
    `user_id`      STRING COMMENT '用户ID',
    `course_id`    STRING COMMENT '课程ID',
    `review_txt`   STRING COMMENT '评论内容',
    `review_stars` STRING COMMENT '评论等级',
    `date_id`      STRING COMMENT '日期id',
    `create_time`  STRING COMMENT '评价时间'
) COMMENT '课程评价事务事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_interaction_course_comment_inc/'
    TBLPROPERTIES ("orc.compress" = "snappy");
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_interaction_course_comment_inc partition(dt)
select
    data.id,
    data.user_id,
    data.course_id,
    data.review_txt,
    data.review_stars,
    date_format(data.create_time,'yyyy-MM-dd') date_id,
    data.create_time,
    date_format(data.create_time,'yyyy-MM-dd')
from ods_review_info_inc
where dt='2022-02-25'
and type = 'bootstrap-insert';
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_interaction_course_comment_inc partition(dt='2022-02-26')
select
    data.id,
    data.user_id,
    data.course_id,
    data.review_txt,
    data.review_stars,
    date_format(data.create_time,'yyyy-MM-dd') date_id,
    data.create_time
from ods_review_info_inc
where dt='2022-02-26'
and type = 'insert';
```



### 3.4.3dwd_interaction_favor_add_inc	互动域收藏课程事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_interaction_favor_add_inc;
CREATE EXTERNAL TABLE dwd_interaction_favor_add_inc
(
    `id`          STRING COMMENT '编号',
    `user_id`     STRING COMMENT '用户id',
    `course_id `  STRING COMMENT '课程id',
    `date_id`     STRING COMMENT '日期id',
    `create_time` STRING COMMENT '收藏时间',
    `update_time` STRING COMMENT '修改时间',
    `deleted`     STRING COMMENT '是否删除'
) COMMENT '收藏事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_interaction_favor_add_inc/'
    TBLPROPERTIES ("orc.compress" = "snappy");
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_interaction_favor_add_inc partition(dt)
select
    data.id,
    data.user_id,
    data.course_id,
    date_format(data.create_time,'yyyy-MM-dd') date_id,
    data.create_time,
    data.update_time,
    data.deleted,
    date_format(data.create_time,'yyyy-MM-dd')
from ods_favor_info_inc
where dt='2022-02-25'
and type = 'bootstrap-insert';
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_interaction_favor_add_inc partition(dt='2022-02-26')
select
   data.id,
   data.user_id,
   data.course_id,
   date_format(data.create_time,'yyyy-MM-dd') date_id,
   data.create_time,
   data.update_time,
   data.deleted
from ods_favor_info_inc
where dt='2022-02-26'
and type = 'insert';
```



## 3.5 用户域（总计2张表）

### 3.5.1 dwd_user_register_inc        用户域用户注册事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_user_register_inc;
CREATE EXTERNAL TABLE dwd_user_register_inc
(
    `user_id`        STRING COMMENT '用户ID',
    `date_id`        STRING COMMENT '日期ID',
    `create_time`    STRING COMMENT '注册时间',
    `channel`        STRING COMMENT '应用下载渠道',
    `province_id`    STRING COMMENT '省份id',
    `version_code`   STRING COMMENT '应用版本',
    `mid_id`         STRING COMMENT '设备id',
    `brand`          STRING COMMENT '设备品牌',
    `model`          STRING COMMENT '设备型号',
    `operate_system` STRING COMMENT '设备操作系统'
) COMMENT '用户域用户注册事务事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_user_register_inc/'
    TBLPROPERTIES ("orc.compress" = "snappy");
```

#### 2 首日导数语句

```mysql
insert overwrite table dwd_user_register_inc partition(dt)
select
    ui.user_id,
    date_format(create_time,'yyyy-MM-dd') date_id,
    create_time,
    channel,
    province_id,
    version_code,
    mid_id,
    brand,
    model,
    operate_system,
    date_format(create_time,'yyyy-MM-dd')
from
(
    select
        data.id user_id,
        data.create_time
    from ods_user_info_inc
    where dt='2022-02-25'
    and type='bootstrap-insert'
)ui
left join
(
    select
        concat(common.ar,'0000') area_code,
        common.ba brand,
        common.ch channel,
        common.md model,
        common.mid mid_id,
        common.os operate_system,
        common.uid user_id,
        common.vc version_code
    from ods_log_inc
    where dt='2022-02-25'
    and common.uid is not null
)log
on ui.user_id=log.user_id
left join
(
    select
        id province_id,
        area_code
    from ods_base_province_full
    where dt='2022-02-25'
)bp
on log.area_code=bp.area_code;
```

#### 3 每日导数语句

```mysql
insert overwrite table dwd_user_register_inc partition(dt='2022-02-26')
select
    ui.user_id,
    date_format(create_time,'yyyy-MM-dd') date_id,
    create_time,
    channel,
    province_id,
    version_code,
    mid_id,
    brand,
    model,
    operate_system
from
(
    select
        data.id user_id,
        data.create_time
    from ods_user_info_inc
    where dt='2022-02-26'
    and type='insert'
)ui
left join
(
    select
        concat(common.ar,'0000') area_code,
        common.ba brand,
        common.ch channel,
        common.md model,
        common.mid mid_id,
        common.os operate_system,
        common.uid user_id,
        common.vc version_code
    from ods_log_inc
    where dt='2022-02-26'
    and common.uid is not null
)log
on ui.user_id=log.user_id
left join
(
    select
        id province_id,
        area_code
    from ods_base_province_full
    where dt='2022-02-26'
)bp
on log.area_code=bp.area_code;
```

### 3.5.2 dwd_user_login_inc        用户域用户登录事务事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dwd_user_login_inc;
CREATE EXTERNAL TABLE dwd_user_login_inc
(
    `user_id`        STRING COMMENT '用户ID',
    `date_id`        STRING COMMENT '日期ID',
    `login_time`     STRING COMMENT '登录时间',
    `channel`        STRING COMMENT '应用下载渠道',
    `province_id`    STRING COMMENT '省份id',
    `version_code`   STRING COMMENT '应用版本',
    `mid_id`         STRING COMMENT '设备id',
    `brand`          STRING COMMENT '设备品牌',
    `model`          STRING COMMENT '设备型号',
    `operate_system` STRING COMMENT '设备操作系统'
) COMMENT '用户域用户登录事务事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dwd/dwd_user_login_inc/'
    TBLPROPERTIES ("orc.compress" = "snappy");
```

#### 2 数据装载

```mysql
insert overwrite table dwd_user_login_inc partition(dt='2022-02-25')
select
    user_id,
    date_format(from_utc_timestamp(ts,'GMT+8'),'yyyy-MM-dd') date_id,
    date_format(from_utc_timestamp(ts,'GMT+8'),'yyyy-MM-dd HH:mm:ss') login_time,
    channel,
    province_id,
    version_code,
    mid_id,
    brand,
    model,
    operate_system
from
(
    select
        user_id,
        channel,
        area_code,
        version_code,
        mid_id,
        brand,
        model,
        operate_system,
        ts
    from
    (
        select
            user_id,
            channel,
            area_code,
            version_code,
            mid_id,
            brand,
            model,
            operate_system,
            ts,
            row_number() over (partition by session_id order by ts) rn
        from
        (
            select
                user_id,
                channel,
                area_code,
                version_code,
                mid_id,
                brand,
                model,
                operate_system,
                ts,
                concat(mid_id,'-',last_value(session_start_point,true) over(partition by mid_id order by ts)) session_id
            from
            (
                select
                    common.uid user_id,
                    common.ch channel,
                    concat(common.ar,'0000') area_code,
                    common.vc version_code,
                    common.mid mid_id,
                    common.ba brand,
                    common.md model,
                    common.os operate_system,
                    ts,
                    if(page.last_page_id is null,ts,null) session_start_point
                from ods_log_inc
                where dt='2022-02-25'
                and page is not null
            )t1
        )t2
        where user_id is not null
    )t3
    where rn=1
)t4
left join
(
    select
        id province_id,
        area_code
    from ods_base_province_full
    where dt='2022-02-25'
)bp
on t4.area_code=bp.area_code;
```

# 四、DWS层最近1日

## 4.1交易域

### 4.1.1 dws_trade_old_order_1d       交易域年龄粒度订单最近1日汇总表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_old_order_1d;
CREATE EXTERNAL TABLE dws_trade_old_order_1d
(
    `user_id`    STRING COMMENT '用户id',
    `old_step` STRING COMMENT '年龄段'
) COMMENT '交易域用户粒度订单最近1日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_order_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_old_order_1d partition(dt)
select
    distinct t1.user_id,
    old_step,
    dt
from (
     select
        user_id,
        dt
     from dwd_trade_order_detail_inc
) t1
left join (
    select
        id user_id,
        year (current_date ()) - year (birthday),
        if ((year (current_date ()) - year (birthday)<20), '20岁以下', if ((year (current_date ()) - year (birthday)<30), '20-30岁', if ((year (current_date ()) - year (birthday)<40), '30-40岁', if ((year (current_date ()) - year (birthday)<50), '40-50岁', '50岁以上')))) old_step
    from dim_user_zip
) t2
on t1.user_id = t2.user_id;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_trade_old_order_1d partition(dt='2022-02-26')
select
    distinct t1.user_id,
    old_step
from (
     select
        user_id,
        dt
     from dwd_trade_order_detail_inc
     where dt = '2022-02-26'
) t1
left join (
    select
        id user_id,
        year (current_date ()) - year (birthday),
        if ((year (current_date ()) - year (birthday)<20), '20岁以下', if ((year (current_date ()) - year (birthday)<30), '20-30岁', if ((year (current_date ()) - year (birthday)<40), '30-40岁', if ((year (current_date ()) - year (birthday)<50), '40-50岁', '50岁以上')))) old_step
    from dim_user_zip
) t2
on t1.user_id = t2.user_id;
```

### 4.1.2 dws_trade_user_course_order_1d 交易域用户课程粒度最近1d订单表        

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_course_order_1d;
CREATE EXTERNAL TABLE dws_trade_user_course_order_1d
(
    `user_id`                   STRING COMMENT '用户id',
    `order_id`                   STRING COMMENT '订单id',
    `course_id`                    STRING COMMENT '课程id',
    `course_name`                  STRING COMMENT '课程名称',
     `subject_id`                    STRING COMMENT '学科id',
     `subject_name`                    STRING COMMENT '学科名称',
    `category_id`              STRING COMMENT '分类id',
    `category_name`            STRING COMMENT '分类名称',
    `province_id`            STRING COMMENT '省份id',
    `order_num_1d`            BIGINT COMMENT '最近一天订单数',
    `origin_price_1d` DECIMAL(16, 2) COMMENT '最近1日下单原始金额',
    `reduce_amount_1d` DECIMAL(16, 2) COMMENT '最近1日优惠价格',
    `final_amount_1d`     DECIMAL(16, 2) COMMENT '最近1日下单最终支付金额'
) COMMENT '交易域用户课程粒度订单最近1日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_course_order_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 每日导数语句

```mysql
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table dws_trade_user_course_order_1d partition(dt)
select order_id,
       user_id,
       ord_de.course_id,
       course_name,
       subject_id,
       subject_name,
       category_id,
       category_name,
       province_id,
       order_num_1d,
       origin_price_1d,
       reduce_amount_1d,
       final_amount_1d,
       dt
from (
     (
     select dt,
       order_id,
       user_id,
       course_id,
            province_id,
            count(*) order_num_1d,
       sum(nvl(origin_amount,0.0)) origin_price_1d,
       sum(nvl(coupon_reduce,0.0)) reduce_amount_1d,
       sum(nvl(final_amount,0.0)) final_amount_1d
from dwd_trade_order_detail_inc
group by dt, order_id, user_id, course_id
         )ord_de left join (
             select course_id,
       course_name,
       subject_id,
       subject_name,
       category_id,
       category_name
from dim_course_full
where dt = '2022-02-25'
    ) dim_cou on ord_de.course_id = dim_cou.course_id
         );
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_trade_user_course_order_1d partition(dt='2022-02-26')
select order_id,
       user_id,
       ord_de.course_id,
       course_name,
       subject_id,
       subject_name,
       category_id,
       category_name,
       province_id,
       order_num_1d,
       origin_price_1d,
       reduce_amount_1d,
       final_amount_1d
from (
     (
     select dt,
       order_id,
       user_id,
       course_id,
            province_id,
            count(*) order_num_1d,
       sum(nvl(origin_amount,0.0)) origin_price_1d,
       sum(nvl(coupon_reduce,0.0)) reduce_amount_1d,
       sum(nvl(final_amount,0.0)) final_amount_1d
from dwd_trade_order_detail_inc
     where dt='2022-02-26'
group by dt, order_id, user_id, course_id,province_id
         )ord_de left join (
             select course_id,
       course_name,
       subject_id,
       subject_name,
       category_id,
       category_name
from dim_course_full
where dt = '2022-02-26'
    ) dim_cou on ord_de.course_id = dim_cou.course_id
         );
```

### 4.1.3 dws_trade_user_order_1d        交易域用户粒度订单最近1日汇总表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_order_1d;
CREATE EXTERNAL TABLE dws_trade_user_order_1d
(
    `user_id`                   STRING COMMENT '用户id',
    `order_count_1d`            BIGINT COMMENT '最近1日下单次数',
    `order_original_amount_1d`  DECIMAL(16, 2) COMMENT '最近1日最近1日下单原始金额',
    `activity_reduce_amount_1d` DECIMAL(16, 2) COMMENT '最近1日下单活动优惠金额',
    `order_total_amount_1d`     DECIMAL(16, 2) COMMENT '最近1日下单最终金额'
) COMMENT '交易域用户粒度订单最近1日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_order_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_user_order_1d partition(dt)
select
    user_id,
    count(distinct(order_id)),
    sum(origin_amount),
    sum(coupon_reduce),
    sum(final_amount),
    dt
from dwd_trade_order_detail_inc
group by user_id,dt;
```

#### 3每日导数语句

```mysql
insert overwrite table dws_trade_user_order_1d partition(dt='2022-02-26')
select
    user_id,
    count(distinct(order_id)),
    sum(origin_amount),
    sum(coupon_reduce),
    sum(final_amount)
from dwd_trade_order_detail_inc
where dt='2022-02-26'
group by user_id;
```



### 4.1.4 dws_trade_user_cart_add_1d        交易域用户粒度加购最近1日汇总表 

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_cart_add_1d;
CREATE EXTERNAL TABLE dws_trade_user_cart_add_1d
(
    `user_id`           STRING COMMENT '用户id',
    `cart_add_count_1d` BIGINT COMMENT '最近1日加购次数'
) COMMENT '交易域用户粒度加购最近1日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_cart_add_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_user_cart_add_1d partition(dt)
select
    user_id,
    count(*),
    dt
from dwd_trade_cart_add_inc
group by user_id,dt;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_trade_user_cart_add_1d partition(dt='2020-06-15')
select
    user_id,
    count(*)
from dwd_trade_cart_add_inc
where dt='2022-02-26'
group by user_id;
```

### 4.1.5 dws_trade_user_payment_1d        交易域用户粒度支付最近1日汇总事实表  

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_payment_1d;
CREATE EXTERNAL TABLE dws_trade_user_payment_1d
(
    `user_id`           STRING COMMENT '用户id',
    `payment_count_1d`  BIGINT COMMENT '最近1日支付次数',
    `payment_amount_1d` DECIMAL(16, 2) COMMENT '最近1日支付金额'
) COMMENT '交易域用户粒度支付最近1日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_payment_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_user_payment_1d partition(dt)
select
    user_id,
    count(distinct(order_id)),
    sum(total_amount),
    dt
from dwd_trade_pay_detail_suc_inc
group by user_id,dt;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_trade_user_payment_1d partition(dt='2022-02-26')
select
    user_id,
    count(distinct(order_id)),
    sum(total_amount)
from dwd_trade_pay_detail_suc_inc
where dt='2022-02-26'
group by user_id;
```

### 4.1.6 dws_trade_order_1d        最近一日交易域订单信息汇总表

#### 1 建表语句

```mysql
drop table if exists dws_trade_order_1d;
create external table dws_trade_order_1d
(
    order_id string comment '订单',
    user_id string comment '用户id',
    create_time string comment '下单时间',
    province_id string comment '省份id',
    province_name string comment  '省份名称',
    iso_3166_2  string comment '省份编码',
    price string comment '订单金额'
)comment '最近一日交易域订单信息汇总表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dws/dws_trade_order_1d'
    tblproperties ('orc.compress'='snappy');
```

#### 2 每日导数语句

```mysql
insert overwrite table dws_trade_order_1d partition (dt='2022-02-25')
select order_id,
       user_id,
       create_time,
       t1.province_id,
       province_name,
       iso_3166_2,
       province_id
from (
     select order_id,
            user_id,
            create_time,
            province_id,
            final_amount price
    from dwd_trade_order_detail_inc
    where dt='2022-02-25'
         ) t1  join (
             select id,
                    province_name,
                    iso_3166_2
             from dim_province_full
             where dt='2022-02-25'
    ) t2 on t1.province_id = t2.id;

drop table if exists dws_trade_order_1d;
create external table dws_trade_order_1d
(
    order_id string comment '订单',
    user_id string comment '用户id',
    create_time string comment '下单时间',
    province_id string comment '省份id',
    province_name string comment  '省份名称',
    iso_3166_2  string comment '省份编码',
    price decimal(16,2) comment '订单金额'
)comment '最近一日交易域订单信息汇总表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dws/dws_trade_order_1d'
    tblproperties ('orc.compress'='snappy');
insert overwrite table dws_trade_order_1d partition (dt='2022-02-25')
select order_id,
       user_id,
       create_time,
       t1.province_id,
       province_name,
       iso_3166_2,
       price
from (
     select order_id,
            user_id,
            create_time,
            province_id,
            final_amount price
    from dwd_trade_order_detail_inc
    where dt='2022-02-25'
         ) t1  join (
             select id,
                    province_name,
                    iso_3166_2
             from dim_province_full
             where dt='2022-02-25'
    ) t2 on t1.province_id = t2.id;
```

### 4.1.7 dws_course_audition_order_1d        最近一日试听下单情况汇总表

#### 1 建表语句

```mysql
drop table if exists dws_course_audition_order_1d;
create external table dws_course_audition_order_1d
(
    user_id string comment '用户id',
    video_id string comment '视频id',
    subject_id string comment '科目id',
    subject_name string comment '科目名称',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    chapter_id string comment '章节id',
    chapter_name string comment '章节名称',
    category_id string comment '分类id',
    category_name string comment '分类名',
    order_id string comment '当日订单号'
)comment '最近一日试听下单情况汇总表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dws/dws_course_audition_order_1d'
    tblproperties ('orc.compress'='snappy');
```

#### 2 每日导数语句

```mysql
insert overwrite table dws_course_audition_order_1d partition (dt='2022-02-25')
select t1.user_id,
       t1.video_id,
       subject_id,
       subject_name,
       t2.course_id,
       course_name,
       chapter_id,
       chapter_name,
       category_id,
       category_name,
       order_id
from (
         select user_id,
                video_id,
                first_time
         from dwd_study_video_per_day_inc
         where dt = '2022-02-25'
     ) t1  join (
         select id,
                subject_id,
                subject_name,
                course_id,
                course_name,
                chapter_id,
                chapter_name,
                category_id,
                category_name
         from dim_video_full
         where dt = '2022-02-25'
    ) t2 on t1.video_id = t2.id
left join (
        select user_id,
               order_id,
               course_id
        from dwd_trade_order_detail_inc
        where dt='2022-02-25'
    ) t3 on t1.user_id = t3.user_id and t2.course_id=t3.course_id
    where concat(t1.user_id,t1.video_id) not in (
    select distinct concat(user_id,video_id)
    from dwd_study_video_per_day_inc
    where dt < '2022-02-25'
    );
```

### 

## 4.2 学习域

### 4.2.1 dws_study_user_chapter_video_play_1d        最近一日视频播放汇总表

#### 1 建表语句

```mysql
drop table if exists dws_study_user_chapter_video_play_1d;
create external table dws_study_user_chapter_video_play_1d
(
    user_id      string comment '用户id',
    course_id    string comment '课程id',
    course_name  string comment '课程名',
    chapter_id   string comment '章节id',
    chapter_name string comment '章节名称',
    category_id  string comment '分类id',
    category_name string comment '分类名',
    during_time  bigint comment '观看时长'
) comment '最近一日视频播放汇总表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dws/dws_study_user_chapter_video_play_1d'
    tblproperties ('orc.compress' = 'snappy');
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_study_user_chapter_video_play_1d partition (dt='2022-02-25')
select user_id,
       course_id,
       course_name,
       chapter_id,
       chapter_name,
       category_id,
       category_name,
       during_time
from (
         select user_id,
                video_id,
                total_time during_time
         from dwd_study_video_per_day_inc
         where dt = '2022-02-25'
     ) t1 join (
         select id,
                course_id,
                course_name,
                chapter_id,
                chapter_name,
                category_id,
                category_name
         from dim_video_full
         where dt='2022-02-25'
    ) t2 on t1.video_id = t2.id;
```

### 4.2.2 dws_study_chapter_finish_1d        最近一日完播用户汇总

#### 1 建表语句

```mysql
drop table if exists dws_study_chapter_finish_1d;
create external table dws_study_chapter_finish_1d
(
    user_id string comment '用户id',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    chapter_id string comment '章节id',
    chapter_name string comment '章节名称',
    video_id string comment '完课视频id'
)comment '最近一日完播用户汇总'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/dws/dws_study_chapter_finish_1d'
    tblproperties ('orc.compress'='snappy');
```

#### 2 每日导数语句

```mysql
insert overwrite table dws_study_chapter_finish_1d partition (dt='2022-02-25')
select user_id,
       course_id,
       course_name,
       chapter_id,
       chapter_name,
       video_id
from (
         select user_id,
                video_id
         from dwd_study_user_chapter_process
         where dt = '2022-02-25'
     ) t1 join (
         select id,
                course_id,
                course_name,
                chapter_id,
                chapter_name
         from dim_video_full
         where dt='2022-02-25'
    ) t2 on t1.video_id = t2.id ;
```

## 4.3 流量域

### 4.3.1 dws_traffic_session_page_view_1d        流量域会话粒度页面浏览最近1日汇总表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_traffic_session_page_view_1d;
CREATE EXTERNAL TABLE dws_traffic_session_page_view_1d
(
    `session_id`     STRING COMMENT '会话id',
    `mid_id`         string comment '设备id',
    `brand`          string comment '手机品牌',
    `model`          string comment '手机型号',
    `operate_system` string comment '操作系统',
    `version_code`   string comment 'app版本号',
    `channel`        string comment '渠道',
    `during_time_1d` BIGINT COMMENT '最近1日访问时长',
    `page_count_1d`  BIGINT COMMENT '最近1日访问页面数'
) COMMENT '流量域会话粒度页面浏览最近1日汇总表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_traffic_session_page_view_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 数据装载

```mysql
insert overwrite table dws_traffic_session_page_view_1d partition(dt='2022-02-25')
select
    session_id,
    mid_id,
    brand,
    model,
    operate_system,
    version_code,
    channel,
    sum(during_time),
    count(*)
from dwd_traffic_page_view_inc
where dt='2022-02-25'
group by session_id,mid_id,brand,model,operate_system,version_code,channel;
```

## 4.4 互动域

### 4.4.1  dws_interaction_course_review_info_1d        用户评价维度表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_interaction_course_review_info_1d;
CREATE TABLE dws_interaction_course_review_info_1d(
    `course_id` STRING COMMENT '课程id',
    `review_stars_5` BIGINT COMMENT '最近一天五星评价人数',
    `review_stars_4` BIGINT COMMENT '最近一天四星评价人数',
    `review_stars_3` BIGINT COMMENT '最近一天三星评价人数',
    `review_stars_2` BIGINT COMMENT '最近一天两星评价人数',
    `review_stars_1` BIGINT COMMENT '最近一天一星评价人数',
    `total_score` BIGINT COMMENT '最近一天总得分',
    `review_num` BIGINT COMMENT '最近一天评价人数'
)COMMENT '用户评价维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_interaction_course_review_info_1d/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_interaction_course_review_info_1d partition (dt)
select course_id,
       5star_num,
       4star_num,
       3star_num,
       2star_num,
       1star_num,
        (5star_num*5)+(4star_num*4)+ (3star_num*3)+ (2star_num*2)+ (1star_num*1),
       review_num,
       date_id
from (
        select course_id,
               sum(`if`(review_stars=5,1,0)) `5star_num`,
               sum(`if`(review_stars=4,1,0)) `4star_num`,
               sum(`if`(review_stars=3,1,0)) `3star_num`,
               sum(`if`(review_stars=2,1,0)) `2star_num`,
               sum(`if`(review_stars=1,1,0)) `1star_num`,
               count(distinct user_id) review_num,
               date_id
    from dwd_interaction_course_comment_inc
    group by course_id,date_id
     ) star;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_interaction_course_review_info_1d partition(dt='2022-02-26')
select course_id,
       5star_num,
       4star_num,
       3star_num,
       2star_num,
       1star_num,
        (5star_num*5)+(4star_num*4)+ (3star_num*3)+ (2star_num*2)+ (1star_num*1),
       review_num
from (
        select course_id,
               sum(`if`(review_stars=5,1,0)) `5star_num`,
               sum(`if`(review_stars=4,1,0)) `4star_num`,
               sum(`if`(review_stars=3,1,0)) `3star_num`,
               sum(`if`(review_stars=2,1,0)) `2star_num`,
               sum(`if`(review_stars=1,1,0)) `1star_num`,
               count(distinct user_id) review_num
    from dwd_interaction_course_comment_inc
        where dt='2022-02-26'
    group by course_id
     ) star;
```

## 4.5 考试域

### 4.5.1 dws_exam_exam_1d        考试域试卷粒度考试最近1日汇总表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_exam_exam_1d;
CREATE EXTERNAL TABLE dws_exam_exam_1d
(
    `papar_id`  STRING COMMENT '试卷id',
    `avg_score_1d` DECIMAL(16, 2) COMMENT '最近1日完成该试卷所有用户的平均成绩',
    `avg_time_1d`  BIGINT COMMENT '最近1日完成该试卷所有用户答卷的平均时长',
    `user_num_1d`  BIGINT COMMENT '最近1日完成该试卷的用户数'
) COMMENT '考试域试卷粒度考试最近1日汇总表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_exam_exam_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_exam_exam_1d partition(dt)
select
       papar_id,
       avg(score) avg_score_1d,
       avg(duration_sec) avg_time_1d,
       count(*) user_num_1d,
       dt
from dwd_exam_user_exam_inc
group by papar_id,dt;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_exam_exam_1d partition(dt='2022-02-26')
select
       papar_id,
       avg(score) avg_score_1d,
       avg(duration_sec) avg_time_1d,
       count(*) user_num_1d
from dwd_exam_user_exam_inc
where dt = '2022-02-26'
group by papar_id;
```

### 4.5.2 dws_exam_course_1d        考试域课程粒度考试最近1日汇总表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_exam_course_1d;
CREATE EXTERNAL TABLE dws_exam_course_1d
(
    `course_id`    STRING COMMENT '课程id',
    `avg_score_1d` DECIMAL(16, 2) COMMENT '最近1日完成该试卷所有用户的平均成绩',
    `avg_time_1d`  BIGINT COMMENT '最近1日完成该试卷所有用户答卷的平均时长',
    `user_num_1d`  BIGINT COMMENT '最近1日完成该试卷的用户数'
) COMMENT '考试域试卷粒度考试最近1日汇总表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_exam_course_1d'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_exam_course_1d partition(dt)
select
       course_id,
       avg(score) avg_score_1d,
       avg(duration_sec) avg_time_1d,
       count(*) user_num_1d,
       dt
from dim_exam_full
group by course_id,dt;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_exam_exam_1d partition(dt='2022-02-26')
select
       papar_id,
       avg(score) avg_score_1d,
       avg(duration_sec) avg_time_1d,
       count(*) user_num_1d
from dwd_exam_user_exam_inc
where dt = '2022-02-26'
group by papar_id;
```



# 五、DWS层最近n日

## 5.1交易域

### 5.1.1  dws_trade_user_order_nd        交易域用户课程粒度最近nd订单表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_course_order_nd;
CREATE EXTERNAL TABLE dws_trade_user_course_order_nd
(
    `user_id`                   STRING COMMENT '用户id',
    `order_id`                   STRING COMMENT '订单id',
    `course_id`                    STRING COMMENT '课程id',
    `course_name`                  STRING COMMENT '课程名称',
     `subject_id`                    STRING COMMENT '学科id',
     `subject_name`                    STRING COMMENT '学科名称',
    `category_id`              STRING COMMENT '分类id',
    `category_name`            STRING COMMENT '分类名称',
    `province_id`              STRING COMMENT '省份id',
    `order_num_7d`            BIGINT COMMENT '最近7天订单数',
    `origin_price_7d` DECIMAL(16, 2) COMMENT '最近7日下单原始金额',
    `reduce_amount_7d` DECIMAL(16, 2) COMMENT '最近7日优惠价格',
    `final_amount_7d`     DECIMAL(16, 2) COMMENT '最近7日下单最终支付金额',
    `order_num_30d`            BIGINT COMMENT '最近30天订单数',
    `origin_price_30d` DECIMAL(16, 2) COMMENT '最近30日下单原始金额',
    `reduce_amount_30d` DECIMAL(16, 2) COMMENT '最近30日优惠价格',
    `final_amount_30d`     DECIMAL(16, 2) COMMENT '最近30日下单最终支付金额'
) COMMENT '交易域用户课程粒度订单最近n日汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_course_order_nd'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_user_course_order_nd partition(dt='2022-02-25')
select order_id,
       user_id,
       course_id,
       course_name,
       subject_id,
       subject_name,
       category_id,
       category_name,
       province_id,
       sum(`if`(dt >= date_sub('2022-02-25', 6), order_num_1d, 0))     order_num_7d,
       sum(`if`(dt >= date_sub('2022-02-25', 6), origin_price_1d, 0))  origin_price_7d,
       sum(`if`(dt >= date_sub('2022-02-25', 6), reduce_amount_1d, 0)) reduce_amount_7d,
       sum(`if`(dt >= date_sub('2022-02-25', 6), final_amount_1d, 0))  final_amount_7d,
       sum(order_num_1d),
       sum(origin_price_1d),
       sum(reduce_amount_1d),
       sum(final_amount_1d)
from dws_trade_user_course_order_1d
where dt >= date_sub('2022-02-25', 29)
group by order_id, user_id, course_id, course_name, subject_id, subject_name, category_id, category_name,province_id;
```

## 5.2 学习域

### 5.2.1 dws_study_user_chapter_video_play_nd         最近n日视频播放汇总表

#### 1 建表语句

```mysql
drop table if exists dws_study_user_chapter_video_play_nd;
create external table dws_study_user_chapter_video_play_nd
(
    user_id      string comment '用户id',
    course_id    string comment '课程id',
    course_name  string comment '课程名',
    chapter_id   string comment '章节id',
    chapter_name string comment '章节名称',
    category_id  string comment '分类id',
    category_name string comment '分类名',
    during_time_7d  bigint comment '7日累计观看时长',
    during_time_30d bigint comment '30日累计观看时长'
) comment '最近n日视频播放汇总表'
    partitioned by (dt string)
    stored as ORC
    location '/warehouse/edu/dws/dws_study_user_chapter_video_play_1d'
    tblproperties ('orc.compress' = 'snappy');
```

#### 2 每日导数语句

```mysql
insert overwrite table dws_study_user_chapter_video_play_nd partition (dt='2022-02-25')
select user_id,
       course_id,
       course_name,
       chapter_id,
       chapter_name,
       category_id,
       category_name,
       sum(if(recent_day = 7,during_time,0)) during_time_7d,
       sum(if(recent_day = 30,during_time,0)) during_time_30d
from dws_study_user_chapter_video_play_1d lateral view explode(array(7,30)) tmp as recent_day
where dt >= date_sub('2022-02-25',recent_day - 1 )
group by user_id, course_id, course_name, chapter_id, chapter_name, category_id, category_name;
```

## 5.3 互动域

### 5.3.1  dws_interaction_course_review_info_nd

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_interaction_course_review_info_nd;
CREATE TABLE dws_interaction_course_review_info_nd(
    `course_id` STRING COMMENT '课程id',
    `review_stars_5_7d` BIGINT COMMENT '最近七天五星评价人数',
    `review_stars_4_7d` BIGINT COMMENT '最近七天四星评价人数',
    `review_stars_3_7d` BIGINT COMMENT '最近七天三星评价人数',
    `review_stars_2_7d` BIGINT COMMENT '最近七天两星评价人数',
    `review_stars_1_7d` BIGINT COMMENT '最近七天一星评价人数',
    `total_score_7d` BIGINT COMMENT '最近七天总评分',
    `review_num_7d` BIGINT COMMENT '最近七天评价人数',
     `review_stars_5_30d` BIGINT COMMENT '最近30天五星评价人数',
    `review_stars_4_30d` BIGINT COMMENT '最近30天四星评价人数',
    `review_stars_3_30d` BIGINT COMMENT '最近30天三星评价人数',
    `review_stars_2_30d` BIGINT COMMENT '最近30天两星评价人数',
    `review_stars_1_30d` BIGINT COMMENT '最近30天一星评价人数',
    `total_score_30d` BIGINT COMMENT '最近30天总得分',
    `review_num_30d` BIGINT COMMENT '最近30天评价人数'
)COMMENT '用户评价维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_interaction_course_review_info_nd/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_interaction_course_review_info_nd partition (dt)
select course_id,
       review_stars_5_7d,
        review_stars_4_7d,
        review_stars_3_7d,
        review_stars_2_7d,
        review_stars_1_7d,
       (review_stars_5_7d*5)+(review_stars_4_7d*4)+(review_stars_3_7d*3)+(review_stars_2_7d*2)+(review_stars_1_7d*1) ,
       review_num_7d  ,
       review_stars_5_30d,
       review_stars_4_30d,
       review_stars_3_30d,
       review_stars_2_30d,
       review_stars_1_30d,
        (review_stars_5_7d*5)+(review_stars_4_7d*4)+(review_stars_3_7d*3)+(review_stars_2_7d*2)+(review_stars_1_7d*1) ,
review_num_30d,
       dt
       from (
     select course_id,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_stars_5,0)) review_stars_5_7d,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_stars_4,0)) review_stars_4_7d,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_stars_3,0)) review_stars_3_7d,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_stars_2,0)) review_stars_2_7d,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_stars_1,0)) review_stars_1_7d,
       sum(`if`(dt >=date_sub('2022-02-25',6),review_num,0)) review_num_7d,
       sum(review_stars_5) review_stars_5_30d,
       sum(review_stars_4) review_stars_4_30d,
       sum(review_stars_3) review_stars_3_30d,
       sum(review_stars_2) review_stars_2_30d,
       sum(review_stars_1) review_stars_1_30d,
       sum(review_num) review_num_30d,
            dt
from dws_interaction_course_review_info_1d
where dt >= date_sub('2022-02-25',29)
group by course_id, dt
         )star;
```

# 六、DWS层历史至今

## 6.1 用户域

### 6.1.1 dws_user_user_login_td        用户域用户粒度登录历史至今汇总表 

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_user_user_login_td;
CREATE EXTERNAL TABLE dws_user_user_login_td
(
    `user_id`         STRING COMMENT '用户id',
    `login_date_last` STRING COMMENT '末次登录日期',
    `login_count_td`  BIGINT COMMENT '累计登录次数'
) COMMENT '用户域用户粒度登录历史至今汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_user_user_login_td'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_user_user_login_td partition(dt='2022-02-25')
select
    u.id,
    nvl(login_date_last,date_format(create_time,'yyyy-MM-dd')),
    nvl(login_count_td,1)
from
(
    select
        id,
        create_time
    from dim_user_zip
    where dt='9999-12-31'
)u
left join
(
    select
        user_id,
        max(dt) login_date_last,
        count(*) login_count_td
    from dwd_user_login_inc
    group by user_id
)l
on u.id=l.user_id;

```

#### 3 每日导数语句

```mysql
insert overwrite table dws_user_user_login_td partition(dt='2022-02-26')
select
    nvl(old.user_id,new.user_id),
    if(new.user_id is null,old.login_date_last,'2022-02-26'),
    nvl(old.login_count_td,0)+nvl(new.login_count_1d,0)
from
(
    select
        user_id,
        login_date_last,
        login_count_td
    from dws_user_user_login_td
    where dt=date_add('2022-02-26',-1)
)old
full outer join
(
    select
        user_id,
        count(*) login_count_1d
    from dwd_user_login_inc
    where dt='2022-02-26'
    group by user_id
)new
on old.user_id=new.user_id;

```

## 6.2 交易域

### 6.2.1 dws_trade_user_order_td        交易域用户粒度订单历史至今汇总事实表

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS dws_trade_user_order_td;
CREATE EXTERNAL TABLE dws_trade_user_order_td
(
    `user_id`                   STRING COMMENT '用户id',
    `order_date_first`          STRING COMMENT '首次下单日期',
    `order_date_last`           STRING COMMENT '末次下单日期',
    `order_count_td`            BIGINT COMMENT '下单次数',
    `original_amount_td`        DECIMAL(16, 2) COMMENT '原始金额',
    `coupon_reduce_amount_td`   DECIMAL(16, 2) COMMENT '活动优惠券优惠金额',
    `total_amount_td`           DECIMAL(16, 2) COMMENT '最终金额'
) COMMENT '交易域用户粒度订单历史至今汇总事实表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/edu/dws/dws_trade_user_order_td'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

#### 2 首日导数语句

```mysql
insert overwrite table dws_trade_user_order_td partition(dt='2022-02-25')
select
    user_id,
    min(dt) login_date_first,
    max(dt) login_date_last,
    sum(order_count_1d) order_count,
    sum(order_original_amount_1d) original_amount,
    sum(activity_reduce_amount_1d) coupon_reduce,
    sum(order_total_amount_1d) total_amount
from dws_trade_user_order_1d
group by user_id;
```

#### 3 每日导数语句

```mysql
insert overwrite table dws_trade_user_order_td partition(dt='2022-02-26')
select
    nvl(old.user_id,new.user_id),
    if(new.user_id is not null and old.user_id is null,'2022-02-26',old.order_date_first),
    if(new.user_id is not null,'2022-02-26',old.order_date_last),
    nvl(old.order_count_td,0)+nvl(new.order_count_1d,0),
    nvl(old.original_amount_td,0)+nvl(new.order_original_amount_1d,0),
    nvl(old.coupon_reduce_amount_td,0)+nvl(new.activity_reduce_amount_1d,0),
    nvl(old.total_amount_td,0)+nvl(new.order_total_amount_1d,0)
from
(
    select
        user_id,
        order_date_first,
        order_date_last,
        order_count_td,
        original_amount_td,
        coupon_reduce_amount_td,
        total_amount_td
    from dws_trade_user_order_td
    where dt=date_add('2022-02-26',-1)
)old
full outer join
(
    select
        user_id,
        order_count_1d,
        order_original_amount_1d,
        activity_reduce_amount_1d,
        order_total_amount_1d
    from dws_trade_user_order_1d
    where dt='2022-02-26'
)new
on old.user_id=new.user_id;
```

# 七、ADS层 

## 7.1 流量主题

### 7.1.1 ads_traffic_stats_by_channel        各渠道流量统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_traffic_stats_by_channel;
CREATE EXTERNAL TABLE ads_traffic_stats_by_channel
(
    `dt`               STRING COMMENT '统计日期',
    `recent_days`      BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `channel`          STRING COMMENT '渠道',
    `uv_count`         BIGINT COMMENT '访客人数',
    `avg_duration_sec` BIGINT COMMENT '会话平均停留时长，单位为秒',
    `avg_page_count`   BIGINT COMMENT '会话平均浏览页面次数',
    `sv_count`         BIGINT COMMENT '会话数',
    `bounce_rate`      DECIMAL(16, 2) COMMENT '跳出率'
) COMMENT '各渠道流量统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_traffic_stats_by_channel/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_traffic_stats_by_channel
select * from ads_traffic_stats_by_channel
union
select
    '2022-02-25' dt,
    recent_days,
    channel,
    cast(count(distinct(mid_id)) as bigint) uv_count,
    cast(avg(during_time_1d)/1000 as bigint) avg_duration_sec,
    cast(avg(page_count_1d) as bigint) avg_page_count,
    cast(count(*) as bigint) sv_count,
    cast(sum(if(page_count_1d=1,1,0))/count(*) as decimal(16,2)) bounce_rate
from dws_traffic_session_page_view_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt>=date_add('2022-02-25',-recent_days+1)
group by recent_days,channel;
```

### 7.1.2 ads_page_path        路径分析  

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_page_path;
CREATE EXTERNAL TABLE ads_page_path
(
    `dt`          STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `source`      STRING COMMENT '跳转起始页面ID',
    `target`      STRING COMMENT '跳转终到页面ID',
    `path_count`  BIGINT COMMENT '跳转次数'
) COMMENT '页面浏览路径分析'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_page_path/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_page_path
select * from ads_page_path
union
select
    '2022-02-25' dt,
    recent_days,
    source,
    nvl(target,'null'),
    count(*) path_count
from
(
    select
        recent_days,
        concat('step-',rn,':',page_id) source,
        concat('step-',rn+1,':',next_page_id) target
    from
    (
        select
            recent_days,
            page_id,
            lead(page_id,1,null) over(partition by session_id order by view_time) next_page_id,
            row_number() over (partition by session_id order by view_time) rn
        from dwd_traffic_page_view_inc lateral view explode(array(1,7,30)) tmp as recent_days
        where dt>=date_add('2022-02-25',-recent_days+1)
    )t1
)t2
group by recent_days,source,target;
```

## 7.2 用户主题

### 7.2.1 ads_user_change         用户变动统计

#### 1.建表语句 

```mysql
DROP TABLE IF EXISTS ads_user_change;
CREATE EXTERNAL TABLE ads_user_change
(
    `dt`               STRING COMMENT '统计日期',
    `user_churn_count` BIGINT COMMENT '流失用户数',
    `user_back_count`  BIGINT COMMENT '回流用户数'
) COMMENT '用户变动统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_user_change/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_user_change
select * from ads_user_change
union
select
    churn.dt,
    user_churn_count,
    user_back_count
from
(
    select
        '2022-02-25' dt,
        count(*) user_churn_count
    from dws_user_user_login_td
    where dt='2022-02-25'
    and login_date_last=date_add('2022-02-25',-7)
)churn
join
(
    select
        '2022-02-25' dt,
        count(*) user_back_count
    from
    (
        select
            user_id,
            login_date_last
        from dws_user_user_login_td
        where dt='2022-02-25'
    )t1
    join
    (
        select
            user_id,
            login_date_last login_date_previous
        from dws_user_user_login_td
        where dt=date_add('2022-02-25',-1)
    )t2
    on t1.user_id=t2.user_id
    where datediff(login_date_last,login_date_previous)>=8
)back
on churn.dt=back.dt;
```

### 7.2.2 ads_user_retention         用户留存率

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_user_retention;
CREATE EXTERNAL TABLE ads_user_retention
(
    `dt`              STRING COMMENT '统计日期',
    `create_date`     STRING COMMENT '用户新增日期',
    `retention_day`   INT COMMENT '截至当前日期留存天数',
    `retention_count` BIGINT COMMENT '留存用户数量',
    `new_user_count`  BIGINT COMMENT '新增用户数量',
    `retention_rate`  DECIMAL(16, 2) COMMENT '留存率'
) COMMENT '用户留存率'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_user_retention/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_user_retention
select * from ads_user_retention
union
select
    '2022-02-25' dt,
    login_date_first create_date,
    datediff('2022-02-25',login_date_first) retention_day,
    sum(if(login_date_last='2022-02-25',1,0)) retention_count,
    count(*) new_user_count,
    cast(sum(if(login_date_last='2022-02-25',1,0))/count(*)*100 as decimal(16,2)) retention_rate
from
(
    select
        user_id,
        date_id login_date_first
    from dwd_user_register_inc
    where dt>=date_add('2022-02-25',-7)
    and dt<'2022-02-25'
)t1
join
(
    select
        user_id,
        login_date_last
    from dws_user_user_login_td
    where dt='2022-02-25'
)t2
on t1.user_id=t2.user_id
group by login_date_first;
```

### 7.2.3 ads_user_action          漏斗分析

#### 1.建表语句

```mysql
fDROP TABLE IF EXISTS ads_user_action;
CREATE EXTERNAL TABLE ads_user_action
(
    `dt`                STRING COMMENT '统计日期',
    `home_count`        BIGINT COMMENT '浏览首页人数',
    `good_detail_count` BIGINT COMMENT '浏览商品详情页人数',
    `cart_count`        BIGINT COMMENT '加入购物车人数',
    `order_count`       BIGINT COMMENT '下单人数',
    `payment_count`     BIGINT COMMENT '支付人数'
) COMMENT '漏斗分析'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_user_action/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_user_action
select * from ads_user_action
union
select
    '2020-06-14' dt,
    home_count,
    course_detail_count,
    cart_count,
    order_count,
    payment_count
from
(
    select
        recent_days,
        sum(if(page_id='home',1,0)) home_count,
        sum(if(page_id='course_detail',1,0)) course_detail_count
    from dws_traffic_page_visitor_page_view_1d lateral view explode(array(1,7,30)) tmp as recent_days
    where dt >= date_sub('2022-02-25',recent_days-1)
    and page_id in ('home','course_detail')
    group by recent_days
)page
join
(
    select
        recent_days,
        count(*) cart_count
    from dws_trade_user_cart_add_1d lateral view explode(array(1,7,30)) tmp as recent_days
    where dt >= date_sub('2022-02-25',recent_days-1)
    group by recent_days
)cart
on page.recent_days=cart.recent_days
join
(
    select
        recent_days,
        count(*) order_count
    from dws_trade_user_order_1d lateral view explode(array(1,7,30)) tmp as recent_days
    where dt >= date_sub('2022-02-25',recent_days-1)
    group by recent_days
)ord
on page.recent_days=ord.recent_days
join
(
    select
        recent_days,
        count(*) payment_count
    from dws_trade_user_payment_1d lateral view explode(array(1,7,30)) tmp as recent_days
    where dt >= date_sub('2022-02-25',recent_days-1)
    group by recent_days
)pay
on page.recent_days=pay.recent_days;
```

### 7.2.4 ads_user_stats        用户新增活跃统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_user_stats;
CREATE EXTERNAL TABLE ads_user_stats
(
    `dt`                STRING COMMENT '统计日期',
    `recent_days`       BIGINT COMMENT '最近n日,1:最近1日,7:最近7日,30:最近30日',
    `new_user_count`    BIGINT COMMENT '新增用户数',
    `active_user_count` BIGINT COMMENT '活跃用户数'
) COMMENT '用户新增活跃统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_user_stats/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_user_stats
select * from ads_user_stats
union
select
    '2022-02-25' dt,
    t1.recent_days,
    new_user_count,
    active_user_count
from
(
    select
        recent_days,
        sum(if(login_date_last>=date_add('2022-02-25',-recent_days+1),1,0)) active_user_count
    from dws_user_user_login_td lateral view explode(array(1,7,30)) tmp as recent_days
    where dt='2022-02-25'
    group by recent_days
)t1
join
(
    select
        recent_days,
        sum(if(date_id>=date_add('2022-02-25',-recent_days+1),1,0)) new_user_count
    from dwd_user_register_inc lateral view explode(array(1,7,30)) tmp as recent_days
    group by recent_days
)t2
on t1.recent_days=t2.recent_days;
```

### 7.2.5 ads_new_order_user_stats        新增交易用户统计

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS ads_new_order_user_stats;
CREATE EXTERNAL TABLE ads_new_order_user_stats
(
    `dt`                   STRING COMMENT '统计日期',
    `recent_days`          BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `new_order_user_count` BIGINT COMMENT '新增下单人数',
    `new_pay_user_count`   BIGINT COMMENT '新增支付人数'
) COMMENT '新增交易用户统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_new_order_userstats/';
```

#### 2 数据装载

```mysql
insert overwrite table ads_new_order_user_stats
select * from ads_new_order_user_stats
union
select
    '2022-02-25' dt,
    no.recent_days,
    new_order_user_count,
    new_pay_user_count
from (
    select
        recent_days,
        sum(if(order_date_first>=date_add('2022-02-25',-recent_days+1),1,0)) new_order_user_count
    from dws_trade_user_order_td lateral view explode(array(1,7,30)) tmp as recent_days
    where dt='2022-02-25'
    group by recent_days
) no
join (
    select
       recent_days,
       sum(if(dt >= date_add('2022-02-25', -recent_days + 1), 1, 0)) new_pay_user_count
    from dws_trade_user_payment_1d lateral view explode(array(1, 7, 30)) tmp as recent_days
    where dt = '2022-02-25'
    group by recent_days
) np
on no.recent_days = np.recent_days
```

## 7.3 课程主题

### 7.3.1 ads_trade_video_retention_by_subject 各学科试听留存统计   

#### 1 建表语句

```mysql
drop table if exists ads_trade_video_retention_by_subject;
create external table ads_trade_video_retention_by_subject(
    dt string comment '统计日期',
    recent_days string comment '1,7天',
    subject_id string comment '学科id',
    subject_name string comment '学科名称',
    people_count bigint comment '试听人数',
    retention_count_rate decimal(16,2) comment '留存人数'
)comment '各学科试听留存统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_trade_video_retention_by_subject';
```

####  2 每日导数语句

```mysql
insert overwrite table ads_trade_video_retention_by_subject
select '2022-02-25',
       1 recent_days,
       dws_course_audition_order_1d.subject_id,
       dws_course_audition_order_1d.subject_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt = '2022-02-25'
group by subject_id, subject_name
union all
select '2022-02-25',
       7 recent_days,
       subject_id,
       subject_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt <= '2022-02-25' and dt >=date_sub('2022-02-25',6)
group by subject_id, subject_name;
```

### 7.3.2 ads_trade_video_retention_by_course          各课程试听留存统计   

#### 1 建表语句

```
drop table if exists ads_trade_video_retention_by_course;
create external table ads_trade_video_retention_by_course(
    dt string comment '统计日期',
    recent_days string comment '1,7天',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    people_count bigint comment '试听人数',
    retention_count_rate decimal(16,2) comment '留存人数'
)comment '各课程试听留存统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_trade_video_retention_by_course';
```

####  2 每日导数语句

```
insert overwrite table ads_trade_video_retention_by_course
select '2022-02-25',
       1 recent_days,
       course_id,
       course_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt = '2022-02-25'
group by course_id, course_name
union all
select '2022-02-25',
       7 recent_days,
       course_id,
       course_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt <= '2022-02-25' and dt >=date_sub('2022-02-25',6)
group by course_id, course_name;

```



## 7.4 交易主题

### 7.4.1 ads_course_order_by_cate        各分类课程交易统计

#### 1 建表语句

```mysql
DROP TABLE IF EXISTS ads_course_order_by_cate;
CREATE EXTERNAL TABLE ads_course_order_by_cate
(
    `dt`                STRING COMMENT '统计日期',
    `recent_days`       BIGINT COMMENT '最近天数,1，7，30天',
    `category_id`             STRING COMMENT '分类ID',
    `category_name`           STRING COMMENT '分类名称',
    `order_num`           BIGINT COMMENT '下单数',
    `order_user_count`           BIGINT COMMENT '下单人数',
    `order_price_amount` DECIMAL(16, 2) COMMENT '下单金额'
) COMMENT '各分类课程交易统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_course_order_by_cate/';
```

#### 2 首日导数语句

```mysql
insert overwrite table ads_course_order_by_subject
select * from ads_course_order_by_subject
union
select '2022-02-25' dt,
       recent_days,
       subject_id,
       subject_name,
       order_num,
       order_user_count,
       order_price_amount
from
(
    select
        1 recent_days,
        subject_id,
       subject_name,
        sum(order_num_1d) order_num,
        count(distinct(user_id)) order_user_count,
           sum(final_amount_1d) order_price_amount
    from dws_trade_user_course_order_1d
    where dt='2022-02-25'
    group by subject_id, 1, subject_name
    union all
    select
        recent_days,
        subject_id,
       subject_name,
        sum(order_num),
        count(distinct(if(order_num>0,user_id,null)))  order_user_count,
           sum(order_price_amount)
    from
    (
        select
            recent_days,
            user_id,
           subject_id,
       subject_name,
            case recent_days
                when 7 then order_num_7d
                when 30 then order_num_30d
            end order_num,
            case recent_days
        when 7 then final_amount_7d
                when 30 then final_amount_30d
            end order_price_amount
        from dws_trade_user_course_order_nd lateral view explode(array(7,30)) tmp as recent_days
        where dt='2022-02-25'
    )t1
    group by subject_id, recent_days, subject_name
)odr;
```

### 7.4.2 ads_course_order_by_subject        各学科课程交易统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_course_order_by_subject;
CREATE EXTERNAL TABLE ads_course_order_by_subject
(
    `dt`                STRING COMMENT '统计日期',
    `recent_days`       BIGINT COMMENT '最近天数,1，7，30天',
    `subject_id`             STRING COMMENT '学科ID',
    `subject_name`           STRING COMMENT '学科名称',
    `order_num`           BIGINT COMMENT '下单数',
    `order_user_count`           BIGINT COMMENT '下单人数',
    `order_price_amount` DECIMAL(16, 2) COMMENT '下单金额'
) COMMENT '各学科课程交易统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_course_order_by_subject/';
```

#### 2 首日导数语句

```mysql
insert overwrite table ads_course_order_by_cate
select * from ads_course_order_by_cate
union
select '2022-02-25' dt,
       recent_days,
       category_id,
       category_name,
       order_num,
       order_user_count,
       order_price_amount
from
(
    select
        1 recent_days,
        category_id,
        category_name,
        sum(order_num_1d) order_num,
        count(distinct(user_id)) order_user_count,
           sum(final_amount_1d) order_price_amount
    from dws_trade_user_course_order_1d
    where dt='2022-02-25'
    group by category_id, 1, category_name
    union all
    select
        recent_days,
        category_id,
        category_name,
        sum(order_num),
        count(distinct(if(order_num>0,user_id,null)))  order_user_count,
           sum(order_price_amount)
    from
    (
        select
            recent_days,
            user_id,
            category_id,
            category_name,
            case recent_days
                when 7 then order_num_7d
                when 30 then order_num_30d
            end order_num,
            case recent_days
        when 7 then final_amount_7d
                when 30 then final_amount_30d
            end order_price_amount
        from dws_trade_user_course_order_nd lateral view explode(array(7,30)) tmp as recent_days
        where dt='2022-02-25'
    )t1
    group by category_id, recent_days, category_name
)odr;

```

### 7.4.3 ads_course_order_by_course        各课程交易统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_course_order_by_course;
CREATE EXTERNAL TABLE ads_course_order_by_course
(
    `dt`                STRING COMMENT '统计日期',
    `recent_days`       BIGINT COMMENT '最近天数,1，7，30天',
    `course_id`             STRING COMMENT '课程ID',
    `course_name`           STRING COMMENT '课程名称',
    `order_num`           BIGINT COMMENT '下单数',
    `order_user_count`           BIGINT COMMENT '下单人数',
    `order_price_amount` DECIMAL(16, 2) COMMENT '下单金额'
) COMMENT '各课程交易统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_course_order_by_course/';
```

#### 2 首日导数语句

```mysql
insert overwrite table ads_course_order_by_course
select * from ads_course_order_by_course
union
select '2022-02-25' dt,
       recent_days,
       course_id,
       course_name,
       order_num,
       order_user_count,
       order_price_amount
from
(
    select
        1 recent_days,
         course_id,
       course_name,
        sum(order_num_1d) order_num,
        count(distinct(user_id)) order_user_count,
           sum(final_amount_1d) order_price_amount
    from dws_trade_user_course_order_1d
    where dt='2022-02-25'
    group by course_id, 1, course_name
    union all
    select
        recent_days,
        course_id,
       course_name,
        sum(order_num),
        count(distinct(if(order_num>0,user_id,null)))  order_user_count,
           sum(order_price_amount)
    from
    (
        select
            recent_days,
            user_id,
            course_id,
       course_name,
            case recent_days
                when 7 then order_num_7d
                when 30 then order_num_30d
            end order_num,
            case recent_days
        when 7 then final_amount_7d
                when 30 then final_amount_30d
            end order_price_amount
        from dws_trade_user_course_order_nd lateral view explode(array(7,30)) tmp as recent_days
        where dt='2022-02-25'
    )t1
    group by course_id, recent_days, course_name
)odr;

```

### 7.4.4 ads_trade_by_old        各年龄段下单用户数

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_trade_by_old;
CREATE EXTERNAL TABLE ads_trade_by_old
(
    `dt`          STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `old_step`    STRING COMMENT '年龄段',
    `user_num`    BIGINT COMMENT '下单人数'
) COMMENT '各年龄段下单用户'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_trade_by_old';
```

#### 2 数据装载

```mysql
insert overwrite table ads_trade_by_old
select * from ads_trade_by_old
union
select
       '2022-02-25' dt,
       recent_days,
       old_step,
       count(*) user_num
from dws_trade_old_order_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt >= date_sub('2022-02-25',recent_days-1)
group by recent_days,old_step;
```

### 7.4.5 ads_trade_order_by_days        交易综合统计

#### 1.建表语句

```mysql
drop table if exists ads_trade_order_by_days;
create external table ads_trade_order_by_days
(
    dt string comment '统计时间',
    recent_days string comment '最近1,7,30天',
    total_price decimal(16,2) comment '下单总额',
    total_order_amount bigint comment '下单数',
    user_count bigint comment '下单人数'
)comment'交易综合统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_trade_order_by_days/';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_trade_order_by_days
select '2022-02-25',
       recent_days,
        sum(if(dt >= date_sub('2022-02-25',recent_days),price,0)) total_price,
        count(if(dt >= date_sub('2022-02-25',recent_days),order_id,null)) total_order_amount,
        count(if(dt >= date_sub('2022-02-25',recent_days),user_id,0)) user_count
from dws_trade_order_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt>=date_sub('2022-02-25',29) and dt <='2022-02-25'
group by recent_days;
```

### 7.4.6 ads_trade_order_by_province        省份粒度交易综合统计

#### 1.建表语句

```mysql
drop table if exists ads_trade_order_by_province;
create external table ads_trade_order_by_province
(
    dt string comment '统计时间',
    recent_days string comment '最近1,7,30天',
    province_id string comment '省份id',
    province_name string comment '省份名称',
    iso_3166_2 string comment '国际编码',
    total_price decimal(16,2) comment '下单总额',
    total_order_amount bigint comment '下单数',
    user_count bigint comment '下单人数'
)comment'省份粒度交易综合统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_trade_order_by_province/';
```

#### 2 每日导数语句

```mysql
drop table if exists ads_trade_video_retention_by_category;
create external table ads_trade_video_retention_by_category(
    dt string comment '统计日期',
    recent_days string comment '1,7天',
    category_id string comment '分类id',
    category_name string comment '分类名称',
    people_count bigint comment '试听人数',
    retention_count_rate decimal(16,2) comment '留存人数'
)comment '各分类试听留存统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_trade_video_retention_by_category';
insert overwrite table ads_trade_video_retention_by_category
select '2022-02-25',
       1 recent_days,
       dws_course_audition_order_1d.category_id,
       dws_course_audition_order_1d.category_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt = '2022-02-25'
group by category_id, category_name
union all
select '2022-02-25',
       7 recent_days,
       category_id,
       category_name,
       count(distinct user_id) people_count,
       round(count(order_id)/count(user_id),2) retention_rate
from dws_course_audition_order_1d
where dt <= '2022-02-25' and dt >=date_sub('2022-02-25',6)
group by category_id, category_name;
```

## 7.5 考试主题

### 7.5.1 ads_exam_by_paper        各试卷相关指标统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_exam_by_paper;
CREATE EXTERNAL TABLE ads_exam_by_paper
(
    `dt`          STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `papar_id`    STRING COMMENT '试卷id',
    `avg_score`   DECIMAL(16, 2) COMMENT '完成该试卷所有用户的平均成绩',
    `avg_time`    BIGINT COMMENT '完成该试卷所有用户答卷的平均时长',
    `user_num`    BIGINT COMMENT '完成该试卷的用户数'
) COMMENT '各试卷相关指标统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_exam_by_paper';
```

#### 2 数据装载

```mysql
insert overwrite table ads_exam_by_paper
select * from ads_exam_by_paper
union
select
       '2022-02-25' dt,
       recent_days,
       papar_id,
       avg(avg_score_1d),
       avg(avg_time_1d),
       sum(user_num_1d)
from dws_exam_exam_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt >= date_sub('2022-02-25',recent_days-1)
group by recent_days,papar_id;
```

### 7.5.2 ads_exam_by_course         各课程考试相关指标统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_exam_by_course;
CREATE EXTERNAL TABLE ads_exam_by_course
(
    `dt`          STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `course_id`   STRING COMMENT '课程id',
    `avg_score`   DECIMAL(16, 2) COMMENT '完成该试卷所有用户的平均成绩',
    `avg_time`    BIGINT COMMENT '完成该试卷所有用户答卷的平均时长',
    `user_num`    BIGINT COMMENT '完成该试卷的用户数'
) COMMENT '各课程考试相关指标统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_exam_by_course';
```

#### 2 数据装载

```mysql
insert overwrite table ads_exam_by_course
select * from ads_exam_by_course
union
select
       '2022-02-25' dt,
       recent_days,
       course_id,
       avg(avg_score_1d),
       avg(avg_time_1d),
       sum(user_num_1d)
from dws_exam_course_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt >= date_sub('2022-02-25',recent_days-1)
group by recent_days,course_id;
```

### 7.5.3 ads_exam_by_question        各题目正确率统计

#### 1.建表语句

```mysql
DROP TABLE IF EXISTS ads_exam_by_question;
CREATE EXTERNAL TABLE ads_exam_by_question
(
    `dt`          STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `question_id` STRING COMMENT '题目id',
    `right_rate`  DECIMAL(16, 2) COMMENT '正确率'
) COMMENT '各题目正确率统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_exam_by_question';
```

#### 2 数据装载

```mysql
insert overwrite table ads_exam_by_question
select * from ads_exam_by_question
union
select
       '2022-02-25' dt,
       recent_days,
       question_id,
       cast(right_num/write_num*100 as DECIMAL(16, 2)) right_rate
from dws_exam_question_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt >= date_sub('2022-02-25',recent_days-1);
```



## 7.6 播放主题

### 7.6.1 ads_study_video_by_course          各课程视频播放统计

#### 1.建表语句

```mysql
drop table if exists ads_study_video_by_course;
create external table ads_study_video_by_course(
    dt string comment '统计日期',
    recent_days string comment '最近1,7,30天',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    play_count bigint comment '播放次数',
    avg_time bigint comment '平均观看时长',
    user_count bigint comment '观看人数'
) comment '各课程视频播放统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_video_by_chapter/';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_study_video_by_course
select '2022-02-25' dt,
       recent_days,
       course_id,
       course_name,
       play_count,
       avg_time,
       user_count
from (
         select 1                                          recent_days,
                course_id,
                course_name,
                count(*)                                   play_count,
                sum(during_time) / count(distinct user_id) avg_time,
                count(distinct user_id)                    user_count
         from dws_study_user_chapter_video_play_1d
         where dt = '2022-02-25'
         group by course_id, course_name
         union all
         select recent_days,
                course_id,
                course_name,
                count(*)                                   play_count,
                sum(during_time) / count(distinct user_id) avg_time,
                count(distinct user_id)                    user_count
         from (
                  select user_id,
                         recent_days,
                         course_id,
                         course_name,
                         case recent_days
                             when 7 then during_time_7d
                             when 30 then during_time_30d
                             end during_time
                  from dws_study_user_chapter_video_play_nd lateral view explode(array(7, 30)) tmp as recent_days
                  where dt = '2022-02-25'
              ) t1 group by course_id,course_name,recent_days
     ) t2;
```

### 7.6.2 ads_study_video_by_chapter        各章节视频播放统计

#### 1.建表语句

```mysql
drop table if exists ads_study_video_by_chapter;
create external table ads_study_video_by_chapter(
    dt string comment '统计日期',
    recent_days string comment '最近1,7,30天',
    chapter_id string comment '章节id',
    chapter_name string comment '章节名称',
    play_count bigint comment '播放次数',
    avg_time bigint comment '平均观看时长',
    user_count bigint comment '观看人数'
) comment '各章节视频播放统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/edu/ads/ads_video_by_chapter/';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_study_video_by_chapter
select '2022-02-25' dt,
       recent_days,
       chapter_id,
       chapter_name,
       play_count,
       avg_time,
       user_count
from (
         select 1                                          recent_days,
                chapter_id,
                chapter_name,
                count(*)                                   play_count,
                sum(during_time) / count(distinct user_id) avg_time,
                count(distinct user_id)                    user_count
         from dws_study_user_chapter_video_play_1d
         where dt = '2022-02-25'
         group by chapter_id, chapter_name
         union all
         select recent_days,
                chapter_id,
                chapter_name,
                count(*)                                   play_count,
                sum(during_time) / count(distinct user_id) avg_time,
                count(distinct user_id)                    user_count
         from (
                  select user_id,
                         recent_days,
                         chapter_id,
                         chapter_name,
                         case recent_days
                             when 7 then during_time_7d
                             when 30 then during_time_30d
                             end during_time
                  from dws_study_user_chapter_video_play_nd lateral view explode(array(7, 30)) tmp as recent_days
                  where dt = '2022-02-25'
              ) t1 group by chapter_id,chapter_name,recent_days
     ) t2;

```

## 7.7 完课主题

### 7.7.1 ads_study_finish_by_course         各课程完课人数统计

#### 1.建表语句 

```mysql
drop table if exists ads_study_finish_by_course;
create external table ads_study_finish_by_course
(
    dt string comment '统计日期',
    recent_days string comment '最近1,7,30天',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    count bigint comment '完课人数'
)comment '各课程完课人数统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_study_finish_by_course';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_study_finish_avg_by_course
select  '2022-02-25' dt,
        recent_days,
        course_id,
        course_name,
        count(distinct if(finish_count>=total_count_by_course,user_id,null)) count
from (
         select user_id,
                recent_days,
                course_name,
                t1.course_id,
                finish_count,
                total_count_by_course
         from (
                  select user_id,
                         recent_days,
                         course_id,
                         course_name,
                         count(distinct course_id) finish_count
                  from dws_study_chapter_finish_1d lateral view explode(array(1, 7, 30)) tmp as recent_days
                  where dt >= date_sub('2022-02-25', recent_days-1)
                    and dt <= '2022-02-25'
                  group by course_id, course_name, recent_days, user_id
              ) t1
                  left join (
             select course_id,
                    count(1) total_count_by_course
             from dim_video_full
             where dt = '2022-02-25'
             group by course_id
         ) t2 on t1.course_id = t2.course_id
     )t3 group by course_name,course_id,recent_days;
```

### 7.7.2 ads_study_finish_avg_by_course  人均完播统计

#### 1.建表语句

```mysql
drop table if exists ads_study_finish_avg_by_course;
create external table ads_study_finish_avg_by_course
(
    dt string comment '统计日期',
    current_dasys string comment '最近1,7,30天',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    avg decimal(16,2) comment '人均完成章节数'
)comment '人均完播统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_study_finish_avg_by_course';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_study_finish_avg_by_course
select '2022-02-25' dt,
       recent_days,
       course_id,
       course_name,
       round(count(user_id)/count(distinct user_id),2) avg
from dws_study_chapter_finish_1d lateral view explode(array(1,7,30)) tmp as recent_days
where dt >= date_sub('2022-02-25',recent_days - 1) and dt <= '2022-02-25'
group by recent_days,course_id,course_name;

drop table if exists ads_study_finish_KPI;
create external table ads_study_finish_KPI
(
    dt string comment '统计日期',
    recent_days string comment '最近1,7,30天',
    amount string comment '完课人数',
    person_time string comment '完课人次'
)comment '完课综合指标统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_study_finish_by_KPI';
insert overwrite table ads_study_finish_KPI
select '2022-02-25' dt,
       recent_days,
       count(distinct if(finish_count=total_count_by_course,user_id,null)) amount,
       count(if(finish_count=total_count_by_course,user_id,null)) person_time
from (
         select recent_days,
                user_id,
                finish_count,
                total_count_by_course
         from (
                  select user_id,
                         recent_days,
                         course_name,
                         course_id,
                         count(user_id) finish_count

                  from (
                           select user_id,
                                  recent_days,
                                  course_id,
                                  course_name,
                                  row_number() over (partition by user_id,video_id) rn
                           from dws_study_chapter_finish_1d lateral view explode(array(1, 7, 30)) tmp as recent_days
                           where dt >= date_sub('2022-02-25', recent_days - 1)
                             and dt <= '2022-02-25'
                       ) t1
                  group by user_id, recent_days,course_id, course_name, rn
              ) t2
                  left join (
             select course_id,
                    count(1) total_count_by_course
             from dim_video_full
             where dt = '2022-02-25'
             group by course_id
         ) t3 on t2.course_id = t3.course_id
     ) t4
group by recent_days;
```

### 7.7.3 ads_study_finish_by_course

#### 1.建表语句

```mysql
drop table if exists ads_study_finish_by_course;
create external table ads_study_finish_by_course
(
    dt string comment '统计日期',
    recent_days string comment '最近1,7,30天',
    course_id string comment '课程id',
    course_name string comment '课程名称',
    count bigint comment '完课人数'
)comment '各课程完课人数统计'
    row format delimited fields terminated by '\t'
    location '/warehouse/edu/ads/ads_study_finish_by_course';
```

#### 2 每日导数语句

```mysql
insert overwrite table ads_study_finish_avg_by_course
select  '2022-02-25' dt,
        recent_days,
        course_id,
        course_name,
        count(distinct if(finish_count>=total_count_by_course,user_id,null)) count
from (
         select user_id,
                recent_days,
                course_name,
                t1.course_id,
                finish_count,
                total_count_by_course
         from (
                  select user_id,
                         recent_days,
                         course_id,
                         course_name,
                         count(distinct course_id) finish_count
                  from dws_study_chapter_finish_1d lateral view explode(array(1, 7, 30)) tmp as recent_days
                  where dt >= date_sub('2022-02-25', recent_days-1)
                    and dt <= '2022-02-25'
                  group by course_id, course_name, recent_days, user_id
              ) t1
                  left join (
             select course_id,
                    count(1) total_count_by_course
             from dim_video_full
             where dt = '2022-02-25'
             group by course_id
         ) t2 on t1.course_id = t2.course_id
     )t3 group by course_name,course_id,recent_days;
```



```mysql

```

